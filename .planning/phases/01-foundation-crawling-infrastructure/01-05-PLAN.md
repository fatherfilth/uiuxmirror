---
phase: 01-foundation-crawling-infrastructure
plan: 05
type: execute
wave: 4
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - src/extractors/radius-shadow-zindex-extractor.ts
  - src/extractors/motion-extractor.ts
  - src/extractors/icon-extractor.ts
  - src/extractors/imagery-extractor.ts
  - src/extractors/extract-all.ts
  - src/extractors/index.ts
autonomous: true

must_haves:
  truths:
    - "Border radii, box shadows, and z-index values are extracted with stacking context awareness"
    - "Motion tokens capture transition durations, easing functions, and animation keyframe names"
    - "Icon analysis detects stroke vs fill style, stroke weight, and size conventions"
    - "Imagery patterns detect aspect ratios, treatment styles, and object-fit conventions"
    - "All extractors attach evidence to every token"
    - "Barrel index re-exports all extractors from both Plan 04 and Plan 05"
  artifacts:
    - path: "src/extractors/radius-shadow-zindex-extractor.ts"
      provides: "Border radius, box shadow, and z-index extraction"
      exports: ["extractRadii", "extractShadows", "extractZIndexes"]
    - path: "src/extractors/motion-extractor.ts"
      provides: "Motion/animation token extraction"
      exports: ["extractMotionTokens"]
    - path: "src/extractors/icon-extractor.ts"
      provides: "Icon style analysis"
      exports: ["extractIconTokens"]
    - path: "src/extractors/imagery-extractor.ts"
      provides: "Imagery pattern detection"
      exports: ["extractImageryTokens"]
    - path: "src/extractors/extract-all.ts"
      provides: "Convenience function to run all extractors"
      exports: ["extractAllTokens"]
    - path: "src/extractors/index.ts"
      provides: "Barrel export of all extractors"
      exports: ["extractColors", "extractTypography", "extractSpacing", "extractCustomProperties", "extractRadii", "extractShadows", "extractZIndexes", "extractMotionTokens", "extractIconTokens", "extractImageryTokens", "extractAllTokens"]
  key_links:
    - from: "src/extractors/radius-shadow-zindex-extractor.ts"
      to: "src/extractors/shared/style-utils.ts"
      via: "uses getAllVisibleElements and parseSizeToPixels"
      pattern: "getAllVisibleElements"
    - from: "src/extractors/index.ts"
      to: "src/extractors/color-extractor.ts"
      via: "re-exports all extractors from Plan 04 and Plan 05"
      pattern: "export.*from"
    - from: "src/extractors/extract-all.ts"
      to: "src/extractors/color-extractor.ts"
      via: "calls all individual extractors via Promise.all"
      pattern: "extractColors|extractTypography"
---

<objective>
Implement the remaining four token extractors: border radii/shadows/z-index (TOKEN-05), motion (TOKEN-06), icons (TOKEN-07), and imagery (TOKEN-08). Then create the barrel index and extractAllTokens convenience function.

Purpose: Complete the full token extraction suite. These secondary tokens (radii, shadows, motion) plus visual pattern tokens (icons, imagery) round out the design DNA capture. Together with Plan 04's extractors, all 8 TOKEN requirements are covered. The barrel index and extractAllTokens function depend on Plan 04's extractors existing first.

Output: Four additional extractor functions, an extractAllTokens convenience function, and a barrel index that exports all extractors for integration.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:/Users/Karl/UIUX-Mirror/.planning/PROJECT.md
@C:/Users/Karl/UIUX-Mirror/.planning/phases/01-foundation-crawling-infrastructure/01-RESEARCH.md
@C:/Users/Karl/UIUX-Mirror/.planning/phases/01-foundation-crawling-infrastructure/01-01-SUMMARY.md
@C:/Users/Karl/UIUX-Mirror/.planning/phases/01-foundation-crawling-infrastructure/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement border radius, box shadow, and z-index extractors</name>
  <files>src/extractors/radius-shadow-zindex-extractor.ts</files>
  <action>
Implement TOKEN-05: border radii, elevation/shadow, and z-index scales.

src/extractors/radius-shadow-zindex-extractor.ts:

1. Export async function extractRadii(page: Page, pageUrl: string): Promise<RadiusToken[]>
   - Get all visible elements (reuse getAllVisibleElements)
   - For each element with borderRadius !== '0px':
     a. Parse borderRadius to pixels (may be shorthand like "8px" or "8px 4px")
     b. Use the largest value as the representative radius
     c. Build RadiusToken: { value: raw string, valuePixels: parsed, evidence: [...] }
   - Deduplicate by valuePixels within page
   - Return sorted by valuePixels ascending (reveals the radius scale)

2. Export async function extractShadows(page: Page, pageUrl: string): Promise<ShadowToken[]>
   - Get all visible elements
   - For each element with boxShadow !== 'none':
     a. Parse boxShadow string into ShadowLayer[] components
       Shadow format: [inset] offsetX offsetY [blur] [spread] color
       Handle multiple layers separated by commas
       Use regex: /(?:inset\s+)?(?:[\d.]+px\s*){2,4}(?:rgba?\([^)]+\)|#[0-9a-f]+|\w+)/gi
     b. Build ShadowToken: { value: raw string, layers: parsed layers, evidence: [...] }
   - Deduplicate by value string (exact match) within page
   - Return array

3. Export async function extractZIndexes(page: Page, pageUrl: string): Promise<ZIndexToken[]>
   - Get all visible elements
   - For each element with zIndex !== 'auto' AND position !== 'static':
     a. Parse zIndex to number
     b. Determine stacking context: check if parent chain has position+zIndex set
        For v1, use simplified approach: identify if element is a direct child of body ('global') or nested ('local')
        This addresses research pitfall #7 (z-index without stacking context awareness)
     c. Build ZIndexToken: { value: parsed number, stackingContext: 'global' | 'local:{parentSelector}', evidence: [...] }
   - Deduplicate by value+stackingContext
   - Return sorted by value ascending
   - Log warning if more than 20 unique z-index values found (likely indicates a z-index mess, not an intentional scale)
  </action>
  <verify>Run `npx tsc --noEmit` -- should compile with zero errors.</verify>
  <done>Radii extractor captures border-radius scale sorted ascending. Shadow extractor parses multi-layer box-shadows into structured layers. Z-index extractor captures values with stacking context awareness (global vs local).</done>
</task>

<task type="auto">
  <name>Task 2: Implement motion, icon, and imagery extractors</name>
  <files>src/extractors/motion-extractor.ts, src/extractors/icon-extractor.ts, src/extractors/imagery-extractor.ts</files>
  <action>
Implement TOKEN-06 (motion), TOKEN-07 (icons), and TOKEN-08 (imagery).

1. src/extractors/motion-extractor.ts -- TOKEN-06:

Export async function extractMotionTokens(page: Page, pageUrl: string): Promise<MotionToken[]>

Implementation:
a. Get all visible elements
b. Extract transition tokens:
   - For each element with transitionDuration !== '0s':
     - Parse duration to ms (handle "0.3s" -> 300, "300ms" -> 300)
     - Get transitionTimingFunction (easing)
     - Build MotionToken with property: 'duration' and property: 'easing'
c. Extract animation tokens:
   - For each element with animationName !== 'none':
     - Get animationDuration, animationTimingFunction
     - Build MotionToken with property: 'keyframe' (value = animation name)
d. Also extract from CSS @keyframes rules via page.evaluate:
   ```
   // Scan stylesheets for @keyframes
   const keyframes: string[] = [];
   for (const sheet of document.styleSheets) {
     try {
       for (const rule of sheet.cssRules) {
         if (rule instanceof CSSKeyframesRule) {
           keyframes.push(rule.name);
         }
       }
     } catch (e) { /* cross-origin, skip */ }
   }
   return keyframes;
   ```
e. Deduplicate by value within page
f. Return array of MotionToken

2. src/extractors/icon-extractor.ts -- TOKEN-07:

Export async function extractIconTokens(page: Page, pageUrl: string): Promise<IconToken[]>

Implementation via page.evaluate:
a. Find inline SVG elements: document.querySelectorAll('svg')
   - For each SVG:
     - Determine style: check if paths have stroke attributes -> 'stroke', fill attributes -> 'fill', both -> 'mixed'
     - Get strokeWeight: parse stroke-width from SVG attributes or computed styles
     - Get size: SVG width/height or viewBox dimensions, convert to pixels
     - Build IconToken: { style, strokeWeight, sizePixels, format: 'svg-inline', evidence: [...] }

b. Find icon images: document.querySelectorAll('img[src*="icon"], img[src*="/icons/"]')
   - For each icon img:
     - Get natural dimensions
     - Build IconToken: { style: 'fill', sizePixels: max(width, height), format: 'svg-img' or 'img', evidence: [...] }
   - Heuristic: images < 64px on either dimension are likely icons (per research recommendation)

c. Deduplicate by style+sizePixels+strokeWeight
d. Return array of IconToken

Note: Icon font detection is deferred to Phase 2 per research recommendation.

3. src/extractors/imagery-extractor.ts -- TOKEN-08:

Export async function extractImageryTokens(page: Page, pageUrl: string): Promise<ImageryToken[]>

Implementation via page.evaluate:
a. Find content images: document.querySelectorAll('img:not([src*="icon"]):not([src*="/icons/"])')
   - Filter to images > 64px in both dimensions (exclude icons)
b. For each image:
   - Calculate aspect ratio from rendered width/height, simplify to common ratios (16:9, 4:3, 1:1, 3:2)
   - Detect treatment from computed styles:
     - borderRadius > 50% of min(width, height) -> 'circular'
     - borderRadius > 0 -> 'rounded'
     - clipPath present -> 'masked'
     - else -> 'rectangular'
   - Get objectFit from computed styles
   - Build ImageryToken: { aspectRatio, treatment, objectFit, evidence: [...] }
c. Also check for background images on elements:
   - Elements with backgroundImage !== 'none' and backgroundSize set
   - Extract aspect ratio from element dimensions
d. Deduplicate by aspectRatio+treatment
e. Return array of ImageryToken
  </action>
  <verify>Run `npx tsc --noEmit` -- should compile with zero errors.</verify>
  <done>Motion extractor captures transition durations/easings and animation keyframes. Icon extractor analyzes SVG stroke/fill patterns and sizes. Imagery extractor detects aspect ratios, treatments (rounded/circular/masked), and object-fit conventions.</done>
</task>

<task type="auto">
  <name>Task 3: Create extractAllTokens convenience function and barrel index</name>
  <files>src/extractors/extract-all.ts, src/extractors/index.ts</files>
  <action>
Create the barrel export file that re-exports all extractors from Plans 04 and 05, plus the extractAllTokens convenience function. This task depends on Plan 04's extractors already existing on disk.

1. src/extractors/extract-all.ts:

```typescript
import type { Page } from 'playwright';
import type { PageTokens } from '../types/index.js';
import { extractColors } from './color-extractor.js';
import { extractTypography } from './typography-extractor.js';
import { extractSpacing } from './spacing-extractor.js';
import { extractCustomProperties } from './custom-properties-extractor.js';
import { extractRadii, extractShadows, extractZIndexes } from './radius-shadow-zindex-extractor.js';
import { extractMotionTokens } from './motion-extractor.js';
import { extractIconTokens } from './icon-extractor.js';
import { extractImageryTokens } from './imagery-extractor.js';

export async function extractAllTokens(page: Page, pageUrl: string): Promise<PageTokens> {
  const [colors, typography, spacing, customProperties, radii, shadows, zIndexes, motion, icons, imagery] = await Promise.all([
    extractColors(page, pageUrl),
    extractTypography(page, pageUrl),
    extractSpacing(page, pageUrl),
    extractCustomProperties(page, pageUrl),
    extractRadii(page, pageUrl),
    extractShadows(page, pageUrl),
    extractZIndexes(page, pageUrl),
    extractMotionTokens(page, pageUrl),
    extractIconTokens(page, pageUrl),
    extractImageryTokens(page, pageUrl),
  ]);

  return { colors, typography, spacing, customProperties, radii, shadows, zIndexes, motion, icons, imagery };
}
```

Use Promise.all to run extractors concurrently (they all read from the same page state, no conflicts).

Note: The PageTokens type should have been defined in Plan 01's types/tokens.ts. If it wasn't, add it there:
```typescript
export interface PageTokens {
  colors: ColorToken[];
  typography: TypographyToken[];
  spacing: SpacingToken[];
  customProperties: CustomPropertyToken[];
  radii: RadiusToken[];
  shadows: ShadowToken[];
  zIndexes: ZIndexToken[];
  motion: MotionToken[];
  icons: IconToken[];
  imagery: ImageryToken[];
}
```

2. src/extractors/index.ts -- Barrel export:

```typescript
// Token extractors - Plan 04
export { extractColors } from './color-extractor.js';
export { extractTypography } from './typography-extractor.js';
export { extractSpacing, detectBaseUnit } from './spacing-extractor.js';
export { extractCustomProperties } from './custom-properties-extractor.js';

// Token extractors - Plan 05
export { extractRadii, extractShadows, extractZIndexes } from './radius-shadow-zindex-extractor.js';
export { extractMotionTokens } from './motion-extractor.js';
export { extractIconTokens } from './icon-extractor.js';
export { extractImageryTokens } from './imagery-extractor.js';

// Shared utilities
export { getAllVisibleElements, parseColorToHex, parseSizeToPixels } from './shared/index.js';

// Convenience: extract all tokens from a page
export { extractAllTokens } from './extract-all.js';
```
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with zero errors.
Run `npx tsx -e "import { extractAllTokens } from './src/extractors/index.js'; console.log('extractAllTokens:', typeof extractAllTokens);"` -- should print 'function'.
  </verify>
  <done>All 10 extractors (8 token types + shared + extract-all) are accessible via single barrel import. extractAllTokens convenience function runs all extractors in parallel.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All extractors importable from src/extractors/index.ts
3. extractAllTokens function runs all extractors via Promise.all
4. Type definitions match Plan 01 token types
</verification>

<success_criteria>
- TOKEN-05: extractRadii, extractShadows, extractZIndexes return typed tokens with evidence
- TOKEN-06: extractMotionTokens captures durations, easings, and keyframe names
- TOKEN-07: extractIconTokens detects SVG stroke/fill style, stroke weight, and size
- TOKEN-08: extractImageryTokens detects aspect ratios, treatments, and object-fit
- All extractors handle errors gracefully
- Barrel index provides single-import access to all extraction functions
- extractAllTokens runs all extractors concurrently via Promise.all
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-crawling-infrastructure/01-05-SUMMARY.md`
</output>
