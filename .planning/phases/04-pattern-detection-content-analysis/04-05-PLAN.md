---
phase: 04-pattern-detection-content-analysis
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/__tests__/patterns/flow-detection.test.ts
  - src/__tests__/content/content-analysis.test.ts
autonomous: true

must_haves:
  truths:
    - "Flow detection tests verify auth, checkout, and search flows are classified correctly from fixture data"
    - "Content analysis tests verify voice/tone, capitalization, and CTA hierarchy detection"
    - "Tests validate cross-page threshold enforcement (patterns on <3 pages get reduced confidence)"
    - "Tests pass without external dependencies (no network, no browser, no API keys)"
    - "All tests pass via `npx vitest run`"
  artifacts:
    - path: "src/__tests__/patterns/flow-detection.test.ts"
      provides: "Unit tests for flow detection pipeline"
      contains: "describe.*flow"
    - path: "src/__tests__/content/content-analysis.test.ts"
      provides: "Unit tests for content analysis pipeline"
      contains: "describe.*content"
  key_links:
    - from: "src/__tests__/patterns/flow-detection.test.ts"
      to: "src/patterns/index.ts"
      via: "imports flow detection functions"
      pattern: "import.*from.*patterns"
    - from: "src/__tests__/content/content-analysis.test.ts"
      to: "src/content/index.ts"
      via: "imports content analysis functions"
      pattern: "import.*from.*content"
---

<objective>
Create unit tests for flow detection and content analysis modules to validate Phase 4 requirements.

Purpose: Verifies PATT-01 (multi-page flow detection) and PATT-02 (content style extraction) work correctly against fixture data. Ensures cross-page thresholds and confidence scoring behave as designed.
Output: Two test files covering flow detection and content analysis with realistic fixture data.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-detection-content-analysis/04-02-SUMMARY.md
@.planning/phases/04-pattern-detection-content-analysis/04-03-SUMMARY.md
@src/types/patterns.ts
@src/types/content-style.ts
@src/types/crawl-config.ts
@src/types/components.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Flow detection unit tests</name>
  <files>src/__tests__/patterns/flow-detection.test.ts</files>
  <action>
Create `src/__tests__/patterns/flow-detection.test.ts` with Vitest:

**Fixture data:** Create mock PageData[] and htmlContents Map simulating:
1. An auth flow: login page (has form with password input) → dashboard page (post-login). URLs: /login, /dashboard
2. A checkout flow: cart page → shipping form → payment form → confirmation. URLs: /cart, /checkout/shipping, /checkout/payment, /order/confirmation
3. A search flow: search page with search input → results page. URLs: /search, /search/results
4. Regular navigation: homepage, about, contact (linked together but no forms)

Each mock PageData needs: url, finalUrl, statusCode (200), title, timestamp, framework ('unknown'), cssInJsLibrary ('none'), htmlContent (realistic HTML with forms/buttons/links as appropriate), screenshotPath (undefined).

The htmlContents Map maps page URLs to their HTML content strings.

**Test suites:**

`describe('buildStateFlowGraph')`:
- 'creates nodes for each page' — graph node count equals page count
- 'creates edges for internal links' — verify edges exist between linked pages
- 'filters navigation edges' — if a link appears on >80% of pages, it should be marked as navigation
- 'handles empty page list' — returns empty graph

`describe('classifyFlow')`:
- 'classifies auth flow with login keywords and password field' — returns 'auth'
- 'classifies checkout flow with cart/payment keywords' — returns 'checkout'
- 'classifies search flow with search input' — returns 'search-filter'
- 'returns unknown for generic navigation' — returns 'unknown'

`describe('detectFlows')`:
- 'detects auth flow from login pages' — finds flow with type 'auth'
- 'detects checkout flow from cart/payment sequence' — finds flow with type 'checkout'
- 'does not classify pure navigation as flow' — regular pages without forms are excluded
- 'includes evidence in detected flows' — each flow has non-empty evidence array
- 'assigns confidence scores' — each flow has confidence > 0 and <= 1
- 'deduplicates overlapping flows' — if paths share >70% nodes, only highest confidence kept
- 'returns empty array for no pages' — graceful empty input

`describe('calculateFlowConfidence')`:
- 'gives higher confidence to auth/checkout than unknown' — auth > unknown
- 'reduces confidence for very long paths' — path with 10+ steps has lower confidence
  </action>
  <verify>Run `npx vitest run src/__tests__/patterns/flow-detection.test.ts` — all tests pass.</verify>
  <done>Flow detection tests validate graph construction, flow classification, and confidence scoring against realistic fixture data. All tests pass without external dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Content analysis unit tests</name>
  <files>src/__tests__/content/content-analysis.test.ts</files>
  <action>
Create `src/__tests__/content/content-analysis.test.ts` with Vitest:

**Fixture data:** Create:
1. Mock HTML content with buttons ("Sign Up", "Learn More", "Cancel", "Buy Now", "Get Started"), headings ("Welcome to Our Platform"), labels ("Email Address", "Password"), error messages ("Sorry, that email is already taken. Please try another.", "Invalid password", "Error: Connection failed"), placeholders ("Enter your email")
2. Mock DetectedComponent[] for buttons with computedStyles:
   - Primary button: backgroundColor='#2563eb', fontWeight='700', borderWidth='0'
   - Secondary button: backgroundColor='transparent', borderWidth='1px', fontWeight='400'
   - Ghost button: backgroundColor='transparent', borderWidth='0', fontWeight='400'
3. Multiple page URLs for cross-page evidence (at least 4 pages)

**Test suites:**

`describe('extractTextSamples')`:
- 'extracts button text' — finds button text samples with context 'button'
- 'extracts heading text' — finds heading text with context 'heading'
- 'extracts error messages' — finds error text with context 'error'
- 'extracts placeholder text' — finds placeholder text with context 'placeholder'
- 'strips HTML tags from text' — nested `<span>` inside button is stripped
- 'filters empty text' — empty buttons produce no samples
- 'includes pageUrl and selector' — each sample has non-empty pageUrl and selector

`describe('analyzeVoiceTone')`:
- 'detects imperative tense in CTAs' — "Sign Up", "Get Started" → imperative
- 'detects urgent tone' — "Buy Now" → urgent or professional
- 'detects perspective' — "Your Account" → second-person
- 'clusters similar voice patterns' — multiple imperative CTAs cluster together
- 'calculates confidence based on frequency' — confidence = cluster_count / total

`describe('analyzeCapitalization')`:
- 'detects title case' — "Sign Up" → title-case
- 'detects sentence case' — "Learn more" → sentence-case
- 'detects uppercase' — "SUBMIT" → uppercase
- 'handles acronyms in text' — "View API Docs" handled without false classification
- 'groups by context' — button patterns separate from heading patterns
- 'enforces minimum sample threshold' — fewer than 5 samples per context returns no patterns for that context

`describe('analyzeErrorMessages')`:
- 'detects reason-suggestion structure' — "Sorry...Please try another" → reason-suggestion
- 'detects prefix-reason structure' — "Error: Connection failed" → prefix-reason
- 'detects apologetic tone' — "Sorry..." → apologetic
- 'detects technical tone' — "Invalid password" → technical or neutral
- 'extracts common prefixes' — "Error:" appears as prefix
- 'returns empty for insufficient samples' — fewer than 3 error samples returns empty

`describe('analyzeCTAHierarchy')`:
- 'classifies primary buttons' — solid bg + bold = primary
- 'classifies secondary buttons' — border + no bg = secondary
- 'classifies ghost buttons' — no border + no bg = ghost
- 'includes usage context' — "Sign Up" → auth context
- 'calculates frequency' — counts how many buttons per level
  </action>
  <verify>Run `npx vitest run src/__tests__/content/content-analysis.test.ts` — all tests pass. Run `npx vitest run` to confirm no regressions in existing tests.</verify>
  <done>Content analysis tests validate text extraction, voice/tone detection, capitalization analysis, error grammar analysis, and CTA hierarchy classification. All tests pass without external dependencies or regressions.</done>
</task>

</tasks>

<verification>
- `npx vitest run src/__tests__/patterns/` — all flow detection tests pass
- `npx vitest run src/__tests__/content/` — all content analysis tests pass
- `npx vitest run` — full test suite passes (no regressions from Phases 1-3)
- Tests use fixture data only (no network, no browser, no API keys)
- Cross-page threshold and confidence scoring validated
</verification>

<success_criteria>
All Phase 4 unit tests pass. Flow detection correctly classifies auth/checkout/search flows. Content analysis correctly identifies voice, capitalization, error, and CTA patterns. No regressions in existing test suite.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-detection-content-analysis/04-05-SUMMARY.md`
</output>
