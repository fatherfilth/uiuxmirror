---
phase: 04-pattern-detection-content-analysis
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/patterns/pattern-store.ts
  - src/patterns/content-analyzer.ts
  - src/patterns/index.ts
  - src/content/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Patterns are stored with evidence links (pageUrls, selectors, occurrence and cross-page counts)"
    - "Content analysis is orchestrated via a single function that runs all analyzers"
    - "Cross-page validation threshold (3+ pages) is enforced before declaring a pattern"
    - "Pattern and content modules are exported from main src/index.ts barrel"
  artifacts:
    - path: "src/patterns/pattern-store.ts"
      provides: "Pattern storage with evidence linking and cross-page validation"
      exports: ["PatternStore"]
    - path: "src/patterns/content-analyzer.ts"
      provides: "Orchestrates all content analyzers into ContentStyleResult"
      exports: ["analyzeContentStyle"]
    - path: "src/index.ts"
      provides: "Main barrel includes pattern and content exports"
      contains: "patterns"
  key_links:
    - from: "src/patterns/pattern-store.ts"
      to: "src/types/patterns.ts"
      via: "uses StoredPattern type"
      pattern: "import.*StoredPattern.*from.*types"
    - from: "src/patterns/content-analyzer.ts"
      to: "src/content/index.ts"
      via: "imports all content analyzers"
      pattern: "import.*from.*content"
    - from: "src/index.ts"
      to: "src/patterns/index.ts"
      via: "re-exports pattern detection"
      pattern: "from.*patterns"
    - from: "src/index.ts"
      to: "src/content/index.ts"
      via: "re-exports content analysis"
      pattern: "from.*content"
---

<objective>
Create pattern storage with evidence linking, orchestrate content analysis, and integrate all Phase 4 modules into the main project exports.

Purpose: Ties together flow detection (04-02) and content analysis (04-03) with persistent storage and evidence tracking. Enforces cross-page validation thresholds. Makes all Phase 4 capabilities accessible from the main package.
Output: Pattern store, content analysis orchestrator, updated barrel exports.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-detection-content-analysis/04-RESEARCH.md
@.planning/phases/04-pattern-detection-content-analysis/04-02-SUMMARY.md
@.planning/phases/04-pattern-detection-content-analysis/04-03-SUMMARY.md
@src/types/patterns.ts
@src/types/content-style.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pattern store with evidence linking and cross-page validation</name>
  <files>src/patterns/pattern-store.ts</files>
  <action>
Create `src/patterns/pattern-store.ts`:

Export class `PatternStore` with:

Constructor: accepts `outputDir: string` (defaults to '.uidna') — patterns will be stored under `{outputDir}/patterns/`

Methods:

`storeFlow(flow: DetectedFlow): StoredPattern` — converts DetectedFlow to StoredPattern:
  - Generates ID from flow type + entry point hash
  - type: 'flow'
  - evidence: extracts pageUrls from flow path (using graph page URLs), selectors from transitions, occurrenceCount from transitions.length, crossPageCount from unique page URLs in path
  - confidence: flow.confidence
  - detectedAt: ISO timestamp
  - Enforces cross-page threshold: if crossPageCount < 3, multiply confidence by 0.5 and log warning
  - Returns the StoredPattern

`storeContentPattern(pattern: VoicePattern | CapitalizationPattern | ErrorMessagePattern | CTAHierarchy, type: StoredPattern['type'], pageUrls: string[]): StoredPattern` — generic content pattern storage:
  - Generates ID from type + hash of pattern characteristics (e.g., tone+tense for voice, style+contexts for capitalization)
  - evidence: pageUrls from input, selectors from examples if available, occurrenceCount from frequency, crossPageCount from unique pageUrls
  - Enforces cross-page threshold: if crossPageCount < 3, multiply confidence by 0.5 and log warning
  - Returns the StoredPattern

`async savePatterns(patterns: StoredPattern[]): Promise<void>` — persists patterns to JSON:
  - Groups by type into separate files: `{outputDir}/patterns/flows.json`, `{outputDir}/patterns/voice-tone.json`, `{outputDir}/patterns/capitalization.json`, `{outputDir}/patterns/error-grammar.json`, `{outputDir}/patterns/cta-hierarchy.json`
  - Uses fs-extra ensureDir + writeJSON
  - Each file is an array of StoredPattern objects

`async loadPatterns(type?: StoredPattern['type']): Promise<StoredPattern[]>` — loads stored patterns:
  - If type specified, loads from specific file
  - If no type, loads all pattern files and merges
  - Returns empty array if files don't exist

Helper: `generatePatternId(type: string, ...seeds: string[]): string` — deterministic ID from type + seed strings using simple hash.

Helper: `enforceThreshold(pattern: StoredPattern, minPages: number): StoredPattern` — adjusts confidence if crossPageCount < minPages.
  </action>
  <verify>Run `npx tsc --noEmit` — compiles. Verify PatternStore class exports and has storeFlow, storeContentPattern, savePatterns, loadPatterns methods.</verify>
  <done>PatternStore persists flow and content patterns to JSON files with evidence linking and cross-page validation threshold enforcement (3+ pages required for full confidence).</done>
</task>

<task type="auto">
  <name>Task 2: Content analysis orchestrator and barrel export integration</name>
  <files>src/patterns/content-analyzer.ts, src/patterns/index.ts, src/content/index.ts, src/index.ts</files>
  <action>
Create `src/patterns/content-analyzer.ts`:

Export `analyzeContentStyle(pages: PageData[], htmlContents: Map<string, string>, components: DetectedComponent[]): ContentStyleResult` that:
1. Extracts TextSamples from all pages using extractTextSamples() for each page's HTML content
2. Runs analyzeVoiceTone() on all samples → voicePatterns
3. Runs analyzeCapitalization() on all samples → capitalizationPatterns
4. Runs analyzeErrorMessages() on error-context samples → errorPatterns
5. Runs analyzeCTAHierarchy() on button components → ctaHierarchy
6. Aggregates totalSamples count
7. Calculates overall confidence as weighted average: voice (0.3) + capitalization (0.3) + CTA (0.25) + errors (0.15) — errors weighted lower because they may not be found (per research pitfall)
8. Returns ContentStyleResult with all sub-results

Update `src/patterns/index.ts`:
- Add exports from pattern-store.ts and content-analyzer.ts
- Keep existing exports from state-graph-builder.ts, flow-classifier.ts, flow-detector.ts

Update `src/content/index.ts`:
- Ensure all content module exports are present (no changes needed if Task 1 of 04-03 already did this, but verify)

Update `src/index.ts`:
- Add: `export * from './patterns/index.js';`
- Add: `export * from './content/index.js';`
- Place these under a `// Phase 4: Pattern Detection & Content Analysis` comment block, following the same pattern as Phases 2 and 3

Verify no export name conflicts with existing modules.
  </action>
  <verify>Run `npx tsc --noEmit` — all files compile with no errors. Verify `import { detectFlows, analyzeContentStyle, PatternStore } from './index.js'` would work. Check no duplicate export names.</verify>
  <done>Content analysis orchestrator runs all analyzers in one call. All Phase 4 modules accessible from main package barrel. No export conflicts.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `src/patterns/pattern-store.ts` exports PatternStore class
- `src/patterns/content-analyzer.ts` exports analyzeContentStyle
- Cross-page threshold (3+ pages) enforced in PatternStore
- `src/index.ts` exports Phase 4 modules
- No export name conflicts across the codebase
</verification>

<success_criteria>
Pattern storage persists all detected patterns with evidence. Content analysis orchestrator provides single entry point. All Phase 4 exports integrated into main package.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-detection-content-analysis/04-04-SUMMARY.md`
</output>
