---
phase: 04-pattern-detection-content-analysis
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/content/text-extractor.ts
  - src/content/voice-analyzer.ts
  - src/content/capitalization-analyzer.ts
  - src/content/grammar-analyzer.ts
  - src/content/cta-hierarchy-analyzer.ts
  - src/content/index.ts
autonomous: true

must_haves:
  truths:
    - "Text samples are extracted from interactive elements (buttons, links, labels, errors, tooltips, headings) with context"
    - "Voice/tone patterns are detected using Compromise NLP (imperative/present/future tense, formal/casual/urgent tone)"
    - "Capitalization rules are identified per context (sentence-case, title-case, uppercase, etc.)"
    - "Error message grammar patterns are extracted (structure, tone, common prefixes)"
    - "CTA hierarchy is detected from button visual prominence (primary/secondary/tertiary/ghost)"
    - "All content patterns include confidence scores based on sample frequency"
  artifacts:
    - path: "src/content/text-extractor.ts"
      provides: "Extracts TextSample objects from raw HTML content"
      exports: ["extractTextSamples"]
    - path: "src/content/voice-analyzer.ts"
      provides: "Analyzes voice/tone patterns using Compromise NLP"
      exports: ["analyzeVoiceTone"]
    - path: "src/content/capitalization-analyzer.ts"
      provides: "Detects capitalization patterns per text context"
      exports: ["analyzeCapitalization", "detectCapitalizationStyle"]
    - path: "src/content/grammar-analyzer.ts"
      provides: "Analyzes error message grammar and structure"
      exports: ["analyzeErrorMessages"]
    - path: "src/content/cta-hierarchy-analyzer.ts"
      provides: "Detects CTA button hierarchy from component data"
      exports: ["analyzeCTAHierarchy"]
    - path: "src/content/index.ts"
      provides: "Barrel export for content analysis modules"
      exports: ["extractTextSamples", "analyzeVoiceTone", "analyzeCapitalization", "analyzeErrorMessages", "analyzeCTAHierarchy"]
  key_links:
    - from: "src/content/voice-analyzer.ts"
      to: "compromise"
      via: "import nlp for NLP analysis"
      pattern: "import.*nlp.*from.*compromise"
    - from: "src/content/capitalization-analyzer.ts"
      to: "title-case"
      via: "import for capitalization detection"
      pattern: "import.*titleCase.*from.*title-case"
    - from: "src/content/text-extractor.ts"
      to: "src/types/content-style.ts"
      via: "returns TextSample[]"
      pattern: "import.*TextSample.*from.*types"
    - from: "src/content/cta-hierarchy-analyzer.ts"
      to: "src/types/components.ts"
      via: "accepts DetectedComponent[] input"
      pattern: "import.*DetectedComponent.*from.*types"
---

<objective>
Build the content analysis pipeline that extracts text samples from interactive elements and analyzes voice/tone, capitalization, error grammar, and CTA hierarchy patterns.

Purpose: Implements PATT-02 (extract content/microcopy rules: voice/tone, CTA hierarchy, capitalization, error message grammar). Uses Compromise NLP for text analysis and title-case for capitalization detection.
Output: Five modules (text-extractor, voice-analyzer, capitalization-analyzer, grammar-analyzer, cta-hierarchy-analyzer) that analyze content patterns with evidence.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-detection-content-analysis/04-RESEARCH.md
@src/types/content-style.ts
@src/types/components.ts
@src/types/evidence.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Text extractor and voice/capitalization analyzers</name>
  <files>src/content/text-extractor.ts, src/content/voice-analyzer.ts, src/content/capitalization-analyzer.ts</files>
  <action>
Create `src/content/text-extractor.ts`:

Export `extractTextSamples(htmlContent: string, pageUrl: string): TextSample[]` that:
1. Extracts text from interactive and content elements using regex patterns on raw HTML:
   - Buttons: `<button...>text</button>` and `<input type="submit" value="text">` → context: 'button'
   - Links with styled appearance: `<a...>text</a>` → context: 'link'
   - Labels: `<label...>text</label>` → context: 'label'
   - Error messages: elements with class/id containing 'error', 'alert', 'warning', 'invalid' → context: 'error'
   - Tooltips: elements with title attribute, `[data-tooltip]`, `role="tooltip"` → context: 'tooltip'
   - Headings: `<h1>` through `<h6>` → context: 'heading'
   - Placeholders: `placeholder="text"` → context: 'placeholder'
2. Strips HTML tags from extracted text, trims whitespace
3. Filters out empty strings and very short text (<2 chars)
4. Generates evidenceId from hash of pageUrl + selector + text
5. Returns TextSample[] with context, selector (reconstructed CSS-like selector), pageUrl

Handle edge cases:
- Nested HTML in button/link text (strip inner tags)
- Multiple classes on error elements (any class containing 'error' qualifies)
- Self-closing elements (inputs with value attribute)
- Text that is only whitespace after stripping

Create `src/content/voice-analyzer.ts`:

Export `analyzeVoiceTone(samples: TextSample[]): VoicePattern[]` that:
1. Filters samples to button/link contexts (CTAs) — these carry voice/tone signal
2. For each sample, uses Compromise NLP (`import nlp from 'compromise'`):
   - Detect tense: `doc.verbs().isImperative().found` → 'imperative', `.isFuture().found` → 'future', else 'present'
   - Detect tone via regex markers:
     - formal: /please|kindly|would you|could you/i
     - casual: /hey|yeah|cool|awesome|grab|check out|let's/i
     - urgent: /now|today|don't miss|limited|hurry|act fast|last chance/i
     - friendly: /welcome|thanks|great|love|enjoy/i
     - Default to 'professional'
   - Detect perspective: /\b(i|we|our|my)\b/i → 'first-person', /\b(you|your|yours)\b/i → 'second-person', else 'third-person'
3. Clusters similar patterns (same tone+tense+perspective) and aggregates examples
4. Calculates confidence per cluster: (cluster_count / total_samples). Minimum 10 samples required for high confidence (>=0.6)
5. Returns VoicePattern[] sorted by confidence descending

Create `src/content/capitalization-analyzer.ts`:

Export `detectCapitalizationStyle(text: string): CapitalizationStyle` that:
1. Returns 'uppercase' if text === text.toUpperCase() and text has letters
2. Returns 'lowercase' if text === text.toLowerCase()
3. Uses `titleCase()` from title-case library to check if text matches title case
4. Checks sentence case: first word capitalized, remaining words lowercase (except acronyms — all-caps words like "API", "CTA")
5. Returns 'mixed' if no pattern matches

Export `analyzeCapitalization(samples: TextSample[]): CapitalizationPattern[]` that:
1. Groups samples by context (button, link, heading, etc.)
2. For each context group, detects capitalization style of each sample
3. Aggregates into CapitalizationPattern objects keyed by style+context
4. Calculates confidence: (pattern_frequency / context_total_count)
5. Requires minimum 5 samples per context to report patterns (per research anti-pattern guidance)
6. Returns CapitalizationPattern[] sorted by frequency descending
  </action>
  <verify>Run `npx tsc --noEmit` — all three files compile. Verify extractTextSamples returns TextSample[]. Verify analyzeVoiceTone uses compromise NLP. Verify detectCapitalizationStyle returns CapitalizationStyle.</verify>
  <done>Text extractor pulls samples from HTML. Voice analyzer detects tone/tense/perspective using NLP. Capitalization analyzer identifies style patterns per context.</done>
</task>

<task type="auto">
  <name>Task 2: Error grammar analyzer, CTA hierarchy analyzer, and barrel export</name>
  <files>src/content/grammar-analyzer.ts, src/content/cta-hierarchy-analyzer.ts, src/content/index.ts</files>
  <action>
Create `src/content/grammar-analyzer.ts`:

Export `analyzeErrorMessages(samples: TextSample[]): ErrorMessagePattern[]` that:
1. Filters samples to context === 'error' only
2. For each error sample, uses Compromise NLP to analyze:
   - Structure detection:
     - 'reason-suggestion' if multiple sentences AND contains suggestion words (please, try, should, can you, make sure)
     - 'prefix-reason' if starts with prefix pattern (error:, warning:, invalid:, oops, sorry, unfortunately)
     - 'question-format' if ends with '?'
     - 'reason-only' otherwise
   - Tone detection:
     - 'apologetic' if contains sorry, apologies, oops, unfortunately
     - 'instructive' if contains suggestion words
     - 'technical' if contains error, invalid, failed, cannot, exception
     - 'neutral' otherwise
   - Prefix extraction: regex match for common prefixes at start of text
   - Action suggestion: boolean based on presence of suggestion words
3. Aggregates by structure+tone key (same as research pattern)
4. Deduplicates commonPrefixes
5. Returns ErrorMessagePattern[] sorted by frequency descending
6. If fewer than 3 error samples found, return empty array with a log warning (per research: insufficient evidence)

Create `src/content/cta-hierarchy-analyzer.ts`:

Export `analyzeCTAHierarchy(components: DetectedComponent[]): CTAHierarchy[]` that:
1. Filters components to type === 'button' only
2. For each button, examines computedStyles:
   - backgroundColor: check if solid (not 'transparent', not 'rgba(0, 0, 0, 0)')
   - borderWidth: parseFloat, >0 means has border
   - fontWeight: parseInt, >=600 means bold
3. Classifies hierarchy level:
   - primary: solid background AND bold font weight (>=600)
   - secondary: has border AND no solid background
   - ghost: no border AND no solid background (text-only)
   - tertiary: everything else (e.g., has background but not bold)
4. Groups by hierarchy level, collecting examples (text, pageUrl, selector)
5. For each level, classifies button context from text content:
   - form-submit: submit, send, save, create, add, post
   - auth: sign in, log in, sign up, register
   - commerce: buy, purchase, checkout, add to cart
   - informational: learn more, read, view, see
   - dismissal: cancel, close, dismiss, skip
   - general: everything else
6. Calculates confidence based on consistency within level (how uniform are the styles?)
7. Returns CTAHierarchy[] sorted by frequency descending

Create `src/content/index.ts` barrel:
Export everything from all five content modules: text-extractor, voice-analyzer, capitalization-analyzer, grammar-analyzer, cta-hierarchy-analyzer.
  </action>
  <verify>Run `npx tsc --noEmit` — all content files compile. Verify analyzeErrorMessages filters to error context. Verify analyzeCTAHierarchy accepts DetectedComponent[]. Verify barrel exports all public functions.</verify>
  <done>Error grammar analyzer detects error message patterns (structure, tone, prefixes). CTA hierarchy analyzer classifies button prominence levels. Barrel export exposes all content analysis functions.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `src/content/text-extractor.ts` exports extractTextSamples
- `src/content/voice-analyzer.ts` exports analyzeVoiceTone using compromise
- `src/content/capitalization-analyzer.ts` exports analyzeCapitalization using title-case
- `src/content/grammar-analyzer.ts` exports analyzeErrorMessages
- `src/content/cta-hierarchy-analyzer.ts` exports analyzeCTAHierarchy
- `src/content/index.ts` barrel re-exports all functions
- Minimum sample thresholds enforced (5 for capitalization, 3 for errors)
</verification>

<success_criteria>
Complete content analysis pipeline: HTML + components in, ContentStyleResult components out. Voice/tone, capitalization, error grammar, and CTA hierarchy patterns detected with confidence and evidence.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-detection-content-analysis/04-03-SUMMARY.md`
</output>
