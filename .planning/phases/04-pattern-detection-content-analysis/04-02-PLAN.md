---
phase: 04-pattern-detection-content-analysis
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/patterns/state-graph-builder.ts
  - src/patterns/flow-classifier.ts
  - src/patterns/flow-detector.ts
  - src/patterns/index.ts
autonomous: true

must_haves:
  truths:
    - "State-flow graph is constructed from crawled page data using Graphology"
    - "Multi-page flows (auth, checkout, onboarding, search/filter) are classified from graph paths"
    - "Flow detection filters out regular navigation and requires form/state-change evidence"
    - "Each detected flow includes confidence score, evidence links, and flow characteristics"
  artifacts:
    - path: "src/patterns/state-graph-builder.ts"
      provides: "Builds directed graph from PageData with nodes=pages and edges=transitions"
      exports: ["buildStateFlowGraph"]
    - path: "src/patterns/flow-classifier.ts"
      provides: "Classifies flow paths into auth/checkout/onboarding/search-filter types"
      exports: ["classifyFlow", "calculateFlowConfidence"]
    - path: "src/patterns/flow-detector.ts"
      provides: "Detects multi-page flows using graph traversal and classification"
      exports: ["detectFlows"]
    - path: "src/patterns/index.ts"
      provides: "Barrel export for pattern detection modules"
      exports: ["buildStateFlowGraph", "detectFlows", "classifyFlow"]
  key_links:
    - from: "src/patterns/state-graph-builder.ts"
      to: "graphology"
      via: "import Graph"
      pattern: "import.*Graph.*from.*graphology"
    - from: "src/patterns/flow-detector.ts"
      to: "src/patterns/state-graph-builder.ts"
      via: "uses buildStateFlowGraph to get graph then traverses"
      pattern: "import.*buildStateFlowGraph"
    - from: "src/patterns/flow-detector.ts"
      to: "src/patterns/flow-classifier.ts"
      via: "classifies detected path sequences"
      pattern: "import.*classifyFlow"
    - from: "src/patterns/flow-detector.ts"
      to: "src/types/patterns.ts"
      via: "returns DetectedFlow[]"
      pattern: "import.*DetectedFlow.*from.*types"
---

<objective>
Build the flow detection pipeline that constructs state-flow graphs from crawled page data and detects multi-page interaction patterns.

Purpose: Implements PATT-01 (detect multi-page interaction patterns: auth flows, checkout, onboarding, search/filter). Uses Graphology for graph construction and traversal.
Output: Three modules (state-graph-builder, flow-classifier, flow-detector) that take crawled PageData and output DetectedFlow[] with evidence.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-detection-content-analysis/04-RESEARCH.md
@src/types/patterns.ts
@src/types/crawl-config.ts
@src/types/evidence.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build state-flow graph from crawled pages and classify flows</name>
  <files>src/patterns/state-graph-builder.ts, src/patterns/flow-classifier.ts</files>
  <action>
Create `src/patterns/state-graph-builder.ts`:

Export `buildStateFlowGraph(pages: PageData[], htmlContents: Map<string, string>)` that:
1. Creates a directed Graphology graph with PageState node attributes and Transition edge attributes
2. For each PageData, creates a node with: url, pageId (derived from URL hash or index), title, formElements (extracted from htmlContent — look for `<form>`, `<input>`, `<select>`, `<textarea>` selectors), interactiveElements (buttons, links with hrefs), evidenceId (from timestamp+url hash)
3. For each page, extracts links from htmlContent (`<a href="...">`) and form actions (`<form action="...">`), resolving relative URLs against the page URL
4. Adds directed edges for link navigation (type: 'click') and form submissions (type: 'submit', method from form)
5. Only adds edges to pages that exist in the graph (internal links within crawl scope)
6. Filters out universal navigation links (links that appear on >80% of pages at same position are likely nav, not flow edges). Track link hrefs across pages; if same href appears on >80% of pages, mark edge as `isNavigation: true`
7. Returns the constructed Graph

Helper: `extractPageElements(htmlContent: string)` - simple regex/string extraction of form selectors, link hrefs, and interactive element selectors from raw HTML. Does NOT need a full DOM parser; regex for `<a href="...">`, `<form action="...">`, `<input`, `<button` is sufficient for graph construction.

Helper: `resolveUrl(base: string, relative: string): string` - resolves relative URLs against base page URL using URL constructor.

Helper: `generatePageId(url: string): string` - creates deterministic page ID from URL (use URL pathname + search params hash).

Create `src/patterns/flow-classifier.ts`:

Export `classifyFlow(graph, path: string[]): FlowType` that:
1. Gets PageState attributes for all nodes in path
2. Checks for auth flow indicators: URL/title keywords (login, sign-in, register, sign-up, authenticate, forgot-password, reset-password), password form fields
3. Checks for checkout flow indicators: URL/title keywords (checkout, cart, payment, shipping, billing, order), payment/card form fields
4. Checks for onboarding flow indicators: URL/title keywords (welcome, getting-started, setup, onboard, tutorial), multi-step progression (3+ steps)
5. Checks for search/filter flow indicators: URL/title keywords (search, filter, results, query, browse), search input fields
6. Falls back to 'multi-step-form' if multiple form pages exist (2+ pages with forms), or 'unknown' otherwise
7. Returns matched FlowType

Export `calculateFlowConfidence(flowType: FlowType, path: string[], graph): number` that:
1. Base confidence from classification: auth=0.8, checkout=0.8, onboarding=0.7, search-filter=0.75, multi-step-form=0.5, unknown=0.3
2. Adjust up for: path length 2-6 (sweet spot), multiple form submissions in path, consistent URL pattern
3. Adjust down for: very long paths (>7 steps, likely navigation), single-page paths, 'unknown' type
4. Clamp to 0-1 range

Export `analyzeFlowCharacteristics(path: string[], graph): FlowCharacteristics` that:
1. hasFormSubmission: any edge in path has action.type === 'submit'
2. requiresAuth: any page in path has auth-related keywords or password fields
3. stepCount: path.length
4. commonKeywords: extract keywords from page titles in path
  </action>
  <verify>Run `npx tsc --noEmit` — both files compile. Verify buildStateFlowGraph accepts PageData[] and returns a Graphology Graph. Verify classifyFlow returns FlowType.</verify>
  <done>State graph builder constructs directed graph from crawled pages with navigation filtering. Flow classifier categorizes paths into auth/checkout/onboarding/search-filter types with confidence scoring.</done>
</task>

<task type="auto">
  <name>Task 2: Implement flow detector and create barrel export</name>
  <files>src/patterns/flow-detector.ts, src/patterns/index.ts</files>
  <action>
Create `src/patterns/flow-detector.ts`:

Export `detectFlows(pages: PageData[], htmlContents: Map<string, string>): DetectedFlow[]` that:
1. Calls `buildStateFlowGraph(pages, htmlContents)` to construct the graph
2. Identifies flow entry points: pages with forms that have low in-degree (few pages link TO them) or pages matching flow-start keywords (login, register, checkout, search)
3. From each entry point, performs BFS traversal using graphology-traversal's bfs() to find connected page sequences
4. Filters out non-flow sequences: requires at least one form submission edge OR state-change indicator in the path. Pure link navigation is not a flow
5. For paths with 2+ pages that pass the filter, classifies using classifyFlow()
6. Calculates confidence using calculateFlowConfidence()
7. Extracts transitions from graph edges along the path
8. Builds FlowCharacteristics using analyzeFlowCharacteristics()
9. Collects evidence IDs from each page in the path
10. Returns DetectedFlow[] sorted by confidence descending
11. Deduplication: if two flows share >70% of their path nodes, keep only the one with higher confidence

Handle edge cases:
- Cycles in graph (BFS already handles with visited set)
- Pages with no forms (skip as flow entry points unless they match entry keywords)
- Dead-end pages (pages with form but no outgoing edges → mark flow as partial, lower confidence by 0.2)
- Empty graph (no pages → return empty array)

Create `src/patterns/index.ts` barrel:
Export everything from state-graph-builder.ts, flow-classifier.ts, flow-detector.ts.
  </action>
  <verify>Run `npx tsc --noEmit` — all pattern files compile. Verify detectFlows signature accepts PageData[] and returns DetectedFlow[]. Verify barrel exports all public functions.</verify>
  <done>Flow detector identifies multi-page interaction patterns from crawled data, classifies them, and returns evidence-linked DetectedFlow objects. Barrel export exposes all pattern detection functions.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `src/patterns/state-graph-builder.ts` exports buildStateFlowGraph
- `src/patterns/flow-classifier.ts` exports classifyFlow, calculateFlowConfidence, analyzeFlowCharacteristics
- `src/patterns/flow-detector.ts` exports detectFlows returning DetectedFlow[]
- `src/patterns/index.ts` barrel re-exports all functions
- Flow detection filters navigation edges (>80% page occurrence)
- Dead-end flows have reduced confidence
</verification>

<success_criteria>
Complete flow detection pipeline: PageData[] in, DetectedFlow[] out. Auth, checkout, onboarding, and search/filter flows are classified with confidence and evidence.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-detection-content-analysis/04-02-SUMMARY.md`
</output>
