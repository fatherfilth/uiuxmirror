---
phase: 04-pattern-detection-content-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/patterns.ts
  - src/types/content-style.ts
  - src/types/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Pattern and content-style type definitions exist and compile without errors"
    - "Graphology, compromise, and supporting libraries are installed and importable"
    - "Type barrel export includes new pattern and content-style types"
  artifacts:
    - path: "src/types/patterns.ts"
      provides: "Flow, transition, and pattern detection types"
      contains: "PageState"
    - path: "src/types/content-style.ts"
      provides: "Voice, tone, capitalization, grammar, CTA hierarchy types"
      contains: "VoicePattern"
    - path: "package.json"
      provides: "New dependencies for Phase 4"
      contains: "graphology"
  key_links:
    - from: "src/types/patterns.ts"
      to: "src/types/evidence.ts"
      via: "import TokenEvidence"
      pattern: "import.*TokenEvidence.*from.*evidence"
    - from: "src/types/content-style.ts"
      to: "src/types/evidence.ts"
      via: "import TokenEvidence"
      pattern: "import.*TokenEvidence.*from.*evidence"
    - from: "src/types/index.ts"
      to: "src/types/patterns.ts"
      via: "re-export pattern types"
      pattern: "from.*patterns"
---

<objective>
Install Phase 4 dependencies and define type systems for pattern detection and content analysis.

Purpose: Establish the type foundation that flow detection (04-02) and content analysis (04-03) modules will build on, plus install all required libraries.
Output: Two new type files (patterns.ts, content-style.ts), updated type barrel, installed dependencies.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-detection-content-analysis/04-RESEARCH.md
@src/types/index.ts
@src/types/evidence.ts
@src/types/components.ts
@src/types/crawl-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Phase 4 dependencies</name>
  <files>package.json</files>
  <action>
Install the following npm packages:

Production dependencies:
- graphology (graph data structure for state-flow graphs)
- graphology-shortest-path (path finding algorithms)
- graphology-components (connected component detection)
- graphology-traversal (BFS/DFS traversal)
- compromise (lightweight NLP for text analysis)
- ts-pattern (TypeScript pattern matching for flow classification)
- title-case (capitalization detection and normalization)

Dev dependencies:
- @types/graphology (TypeScript types for graphology)

Run: `npm install graphology graphology-shortest-path graphology-components graphology-traversal compromise ts-pattern title-case`
Run: `npm install -D @types/graphology`

After install, verify all packages resolve correctly by checking that `import Graph from 'graphology'` and `import nlp from 'compromise'` compile.
  </action>
  <verify>Run `npm ls graphology compromise ts-pattern title-case` — all listed without UNMET PEER DEPENDENCY. Run `npx tsc --noEmit` — no new type errors from dependencies.</verify>
  <done>All 7 production dependencies and 1 dev dependency installed and importable.</done>
</task>

<task type="auto">
  <name>Task 2: Define pattern and content-style type systems</name>
  <files>src/types/patterns.ts, src/types/content-style.ts, src/types/index.ts</files>
  <action>
Create `src/types/patterns.ts` with these types (import TokenEvidence from evidence.ts):

- `PageState`: url, pageId, title, formElements (string[]), interactiveElements (string[]), evidenceId (string)
- `TransitionAction`: type ('click' | 'submit' | 'navigation'), selector? (string), method? ('GET' | 'POST')
- `Transition`: fromState (string), toState (string), action (TransitionAction), evidence (object with pageUrl, timestamp, screenshotPath?)
- `FlowType`: 'auth' | 'checkout' | 'onboarding' | 'search-filter' | 'multi-step-form' | 'unknown'
- `FlowCharacteristics`: hasFormSubmission (boolean), requiresAuth (boolean), stepCount (number), commonKeywords (string[])
- `DetectedFlow`: type (FlowType), entryPoint (string), exitPoint (string), path (string[]), transitions (Transition[]), confidence (number), evidence (string[]), characteristics (FlowCharacteristics)
- `StoredPattern`: id (string), type ('flow' | 'voice-tone' | 'capitalization' | 'error-grammar' | 'cta-hierarchy'), pattern (DetectedFlow | any), evidence (object with pageUrls, selectors, screenshotPaths, occurrenceCount, crossPageCount), confidence (number), detectedAt (string)

Create `src/types/content-style.ts` with these types (import TokenEvidence from evidence.ts):

- `TextContext`: 'button' | 'link' | 'label' | 'error' | 'tooltip' | 'heading' | 'placeholder'
- `TextSample`: text (string), context (TextContext), selector (string), pageUrl (string), evidenceId (string)
- `CapitalizationStyle`: 'sentence-case' | 'title-case' | 'uppercase' | 'lowercase' | 'mixed'
- `CapitalizationPattern`: style (CapitalizationStyle), examples (string[]), frequency (number), contexts (TextContext[]), confidence (number)
- `ToneType`: 'formal' | 'casual' | 'professional' | 'friendly' | 'urgent'
- `TenseType`: 'imperative' | 'present' | 'future'
- `PerspectiveType`: 'first-person' | 'second-person' | 'third-person'
- `VoicePattern`: tone (ToneType), tense (TenseType), perspective (PerspectiveType), examples (string[]), confidence (number)
- `CTALevel`: 'primary' | 'secondary' | 'tertiary' | 'ghost'
- `CTACharacteristics`: hasBackground (boolean), hasBorder (boolean), textColor (string), backgroundColor? (string), borderColor? (string), fontWeight (string), usageContexts (string[])
- `CTAHierarchy`: level (CTALevel), characteristics (CTACharacteristics), examples (array of {text, pageUrl, selector}), frequency (number), confidence (number)
- `ErrorStructure`: 'prefix-reason' | 'reason-only' | 'reason-suggestion' | 'question-format'
- `ErrorTone`: 'apologetic' | 'neutral' | 'instructive' | 'technical'
- `ErrorMessagePattern`: structure (ErrorStructure), tone (ErrorTone), examples (string[]), commonPrefixes (string[]), suggestsAction (boolean), frequency (number)
- `ContentStyleResult`: voicePatterns (VoicePattern[]), capitalizationPatterns (CapitalizationPattern[]), ctaHierarchy (CTAHierarchy[]), errorPatterns (ErrorMessagePattern[]), totalSamples (number), confidence (number)

Update `src/types/index.ts` to re-export all types from both new files using `export type { ... } from './patterns.js'` and `export type { ... } from './content-style.js'`.
  </action>
  <verify>Run `npx tsc --noEmit` — compiles without errors. Verify both type files export expected types by checking the barrel.</verify>
  <done>Pattern types (PageState, DetectedFlow, StoredPattern, etc.) and content-style types (VoicePattern, CTAHierarchy, ErrorMessagePattern, etc.) defined and exported from type barrel.</done>
</task>

</tasks>

<verification>
- `npm ls graphology compromise ts-pattern title-case` shows all installed
- `npx tsc --noEmit` passes with zero errors
- `src/types/patterns.ts` exists and exports PageState, DetectedFlow, StoredPattern
- `src/types/content-style.ts` exists and exports VoicePattern, CTAHierarchy, ErrorMessagePattern, ContentStyleResult
- `src/types/index.ts` re-exports from both new type files
</verification>

<success_criteria>
All Phase 4 dependencies installed and type system defined. Both flow detection and content analysis plans can start without type conflicts.
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-detection-content-analysis/04-01-SUMMARY.md`
</output>
