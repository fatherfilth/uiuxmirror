---
phase: 05-export-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/export/index.ts
  - src/export/evidence-linker.ts
  - src/export/semantic-namer.ts
  - src/export/reports/markdown-utils.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Evidence citations format consistently across all export consumers"
    - "Token names are semantic (color-primary, heading-1, spacing-sm) not numeric"
    - "Markdown tables render correctly in GitHub-flavored markdown"
  artifacts:
    - path: "src/export/evidence-linker.ts"
      provides: "Inline evidence citation formatting"
      exports: ["formatEvidenceCitation", "formatEvidenceSummary"]
    - path: "src/export/semantic-namer.ts"
      provides: "Semantic token naming algorithm"
      exports: ["generateSemanticColorName", "generateSemanticTypographyName", "generateSemanticSpacingName", "generateTokenVarName"]
    - path: "src/export/reports/markdown-utils.ts"
      provides: "Markdown generation utilities"
      exports: ["generateTable", "codeBlock", "heading"]
    - path: "src/export/index.ts"
      provides: "Export module barrel"
  key_links:
    - from: "src/export/evidence-linker.ts"
      to: "src/types/evidence.ts"
      via: "TokenEvidence type consumption"
      pattern: "import.*TokenEvidence"
    - from: "src/export/semantic-namer.ts"
      to: "src/types/normalized-tokens.ts"
      via: "ColorCluster, NormalizedTypographyToken consumption"
      pattern: "import.*ColorCluster"
---

<objective>
Build shared export utilities: evidence citation formatter, semantic token naming algorithm, and markdown generation helpers.

Purpose: All Phase 5 exports share these three concerns. Evidence citations appear in reports and JSON rich layers. Semantic names appear in CSS vars, Tailwind config, Figma tokens, JSON keys, and reports. Markdown utilities generate tables and code blocks for both the Brand DNA Report and Content Style Guide.

Output: `src/export/` module with evidence-linker.ts, semantic-namer.ts, reports/markdown-utils.ts, and barrel index.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-export-reporting/05-RESEARCH.md
@.planning/phases/05-export-reporting/05-CONTEXT.md
@src/types/evidence.ts
@src/types/normalized-tokens.ts
@src/types/tokens.ts
@src/output/dtcg-formatter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install markdown-table and create evidence linker + semantic namer</name>
  <files>
    package.json
    src/export/evidence-linker.ts
    src/export/semantic-namer.ts
  </files>
  <action>
1. Install markdown-table: `npm install markdown-table`

2. Create `src/export/evidence-linker.ts`:
   - `formatEvidenceCitation(evidence: TokenEvidence[], maxSources?: number): string` — Takes evidence array, returns parenthetical citation string. Shows first 3 (configurable) source page paths, with "+N more" suffix if more exist. Use `new URL(e.pageUrl).pathname` for human-readable paths. If pathname is "/", show hostname instead. Per user decision: inline parenthetical citations.
   - `formatEvidenceSummary(evidence: TokenEvidence[]): { pageCount: number, elementCount: number, pages: string[] }` — Returns structured summary for JSON rich layer. Counts unique pages from evidence, total elements, and list of unique page paths.
   - `formatEvidenceForJSON(evidence: TokenEvidence[]): Array<{ pageUrl: string, selector: string, screenshotPath?: string }>` — Maps evidence to simplified JSON-safe structure for rich layer export. Strip computedStyles and boundingBox (too verbose for export).

3. Create `src/export/semantic-namer.ts`:
   - `generateSemanticColorName(cluster: { canonical: string, variants: string[], occurrences: number }, index: number, total: number): string` — Uses hue analysis from culori to classify colors: grays (saturation <10%) get "neutral-N", most frequent saturated color gets "primary", second gets "secondary", third gets "accent", remaining get "color-N". Use culori's `parse()` and `oklch()` for hue/saturation analysis. Return kebab-case name.
   - `generateSemanticTypographyName(token: { normalizedSize: { pixels: number }, weight: number }, index: number, total: number): string` — Sort by size descending. First 20% = "heading-N", next 30% = "subheading-N", rest = "body-N". Matches existing dtcg-formatter pattern but improved.
   - `generateSemanticSpacingName(token: { normalizedValue: { pixels: number } }, index: number, total: number): string` — Map to t-shirt sizes: xs, sm, md, lg, xl, 2xl, 3xl. If more than 7 sizes, use numeric suffix for extras.
   - `generateRadiusName(index: number, total: number): string` — "radius-sm", "radius-md", "radius-lg" for <=3, else "radius-N".
   - `generateShadowName(index: number, total: number): string` — "shadow-sm", "shadow-md", "shadow-lg" for <=3, else "shadow-N".
   - `generateMotionName(token: { property: string }, index: number): string` — "duration-N" or "easing-N" based on property.
   - `generateTokenVarName(name: string): string` — Converts semantic name to CSS var name: `--${name}` (just prepend `--`). Simple helper for consistency.
   - All names must be lowercase kebab-case. Validate no case-only collisions by deduplicating.
  </action>
  <verify>
    - `npx tsc --noEmit --skipLibCheck` passes (0 errors)
    - `node -e "import('markdown-table').then(m => console.log(typeof m.markdownTable))"` outputs "function"
  </verify>
  <done>
    - evidence-linker.ts exports formatEvidenceCitation, formatEvidenceSummary, formatEvidenceForJSON
    - semantic-namer.ts exports all naming functions with culori-based color classification
    - markdown-table installed in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create markdown utilities and export module barrel</name>
  <files>
    src/export/reports/markdown-utils.ts
    src/export/index.ts
  </files>
  <action>
1. Create `src/export/reports/markdown-utils.ts`:
   - `generateTable(headers: string[], rows: string[][], align?: ('l' | 'c' | 'r')[]): string` — Wraps `markdownTable` from markdown-table library. Takes headers and rows arrays, optional alignment. Returns GFM-compliant table string.
   - `codeBlock(code: string, lang?: string): string` — Wraps code in fenced code block with optional language tag. Trims trailing whitespace.
   - `heading(text: string, level: 1 | 2 | 3 | 4 | 5 | 6): string` — Returns markdown heading with correct # prefix.
   - `bold(text: string): string` — Wraps in ** for bold.
   - `inlineCode(text: string): string` — Wraps in backticks.
   - `link(text: string, url: string): string` — Returns `[text](url)`.
   - `section(heading: string, level: number, content: string): string` — Combines heading + blank line + content for consistent section formatting.

2. Create `src/export/index.ts` barrel:
   - Re-export everything from evidence-linker.ts
   - Re-export everything from semantic-namer.ts
   - Re-export everything from reports/markdown-utils.ts
   - This barrel will be extended in later plans as more modules are added.
  </action>
  <verify>
    - `npx tsc --noEmit --skipLibCheck` passes (0 errors)
    - All exports are importable: check with `npx tsx -e "import { formatEvidenceCitation, generateSemanticColorName, generateTable } from './src/export/index.js'; console.log('OK')"`
  </verify>
  <done>
    - markdown-utils.ts exports all markdown generation helpers wrapping markdown-table
    - src/export/index.ts barrel re-exports all shared utilities
    - TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --skipLibCheck` — Zero TypeScript errors
- All three utility modules exist and export expected functions
- markdown-table dependency in package.json
- Evidence linker produces parenthetical citations with first 3 sources
- Semantic namer produces kebab-case names with color hue classification
</verification>

<success_criteria>
- Evidence citation function returns "page1, page2, page3 (+N more)" format
- Semantic color naming uses culori hue analysis for primary/secondary/accent/neutral classification
- Typography naming follows heading/subheading/body pattern by size
- Spacing naming uses t-shirt size scale (xs through 3xl)
- Markdown table function wraps markdown-table library correctly
- All exports accessible from src/export/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/05-export-reporting/05-01-SUMMARY.md`
</output>
