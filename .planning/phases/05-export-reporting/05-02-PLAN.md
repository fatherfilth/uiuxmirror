---
phase: 05-export-reporting
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/export/formatters/json-layers.ts
  - src/export/formatters/index.ts
autonomous: true

must_haves:
  truths:
    - "tokens.json has quick-lookup layer (name->value map) and rich context layer (evidence, confidence)"
    - "components.json exports observed components with variants, states, and canonical styles"
    - "patterns.json exports detected interaction flows with path sequences"
    - "content_style.json exports voice, capitalization, CTA, and error patterns"
    - "evidence_index.json maps evidence IDs to page URLs, selectors, and screenshots"
  artifacts:
    - path: "src/export/formatters/json-layers.ts"
      provides: "Dual-layer JSON export generators for all 5 file types"
      exports: ["generateTokensJSON", "generateComponentsJSON", "generatePatternsJSON", "generateContentStyleJSON", "generateEvidenceIndexJSON"]
    - path: "src/export/formatters/index.ts"
      provides: "Formatters barrel export"
  key_links:
    - from: "src/export/formatters/json-layers.ts"
      to: "src/export/semantic-namer.ts"
      via: "Semantic token names as JSON keys"
      pattern: "import.*generateSemantic"
    - from: "src/export/formatters/json-layers.ts"
      to: "src/export/evidence-linker.ts"
      via: "Evidence formatting for rich layer"
      pattern: "import.*formatEvidence"
---

<objective>
Generate dual-layer JSON exports for all 5 machine-readable files: tokens.json, components.json, patterns.json, content_style.json, and evidence_index.json.

Purpose: Machine-readable JSON exports are consumed by both developers (quick-lookup layer) and Claude agents (rich context layer). Per user decision, every JSON export has two layers — quick access for grabbing values, rich context for reasoning about design decisions.

Output: `src/export/formatters/json-layers.ts` generating all 5 JSON export files with dual-layer structure.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-export-reporting/05-RESEARCH.md
@.planning/phases/05-export-reporting/05-CONTEXT.md
@.planning/phases/05-export-reporting/05-01-SUMMARY.md
@src/types/normalized-tokens.ts
@src/types/components.ts
@src/types/patterns.ts
@src/types/content-style.ts
@src/types/evidence.ts
@src/types/synthesis.ts
@src/output/dtcg-formatter.ts
@src/components/component-aggregator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dual-layer JSON generators for tokens, components, and evidence</name>
  <files>
    src/export/formatters/json-layers.ts
  </files>
  <action>
Create `src/export/formatters/json-layers.ts` with TypeScript interfaces and generator functions:

**Shared types:**
```typescript
interface DualLayerExport<Q, R> {
  quick: Q;
  rich: R;
  metadata: { generatedAt: string; version: string };
}
```

**1. `generateTokensJSON(result: NormalizationResult): DualLayerExport<...>`**
- **Quick layer**: `Record<string, string>` — token name to CSS value. Keys use semantic names from semantic-namer (e.g., "color-primary" -> "#3b82f6"). Include all token types: colors, typography (size, weight, family, line-height as separate entries), spacing, radii, shadows, motion.
- **Rich layer**: `Record<string, RichToken>` where RichToken = `{ value: string, type: string, description: string, evidence: SimplifiedEvidence[], confidence: { value: number, level: string, reasoning: string }, relationships?: { similarTo?: string[], usedIn?: string[] } }`. Use formatEvidenceForJSON from evidence-linker. Use formatEvidenceSummary for description text.
- Sort color standards by occurrence (from NormalizationResult), typography by size descending, spacing by value ascending — consistent with dtcg-formatter.

**2. `generateComponentsJSON(components: AggregatedComponent[]): DualLayerExport<...>`**
- **Quick layer**: `Record<string, { type: string, variantCount: number, pageCount: number }>` — component type to summary.
- **Rich layer**: `Record<string, RichComponent>` where RichComponent = `{ type: string, instances: number, pageUrls: string[], canonicalStyles: Record<string, string>, variants: Array<{ size?: string, emphasis?: string }>, states: string[] | null, confidence: { value: number, level: string }, evidence: SimplifiedEvidence[] }`. Convert Set to Array for pageUrls. Extract state names from StateMapping if available.
- Key each component by its type (e.g., "button", "card").

**3. `generateEvidenceIndexJSON(evidenceIndex: EvidenceIndex): object`**
- Single layer (no dual structure needed — it IS the evidence). Export the full entries map plus byPage and bySelector indexes. Strip computedStyles (too large) but keep pageUrl, selector, timestamp, screenshotPath, boundingBox.
- Include metadata: total entries count, unique pages count, generation timestamp.
  </action>
  <verify>
    - `npx tsc --noEmit --skipLibCheck` passes (0 errors)
    - All three generator functions compile with correct input types
  </verify>
  <done>
    - generateTokensJSON produces quick (name->value) and rich (name->full context) layers for all token types
    - generateComponentsJSON produces component catalog with variant/state info
    - generateEvidenceIndexJSON exports full evidence index without verbose computedStyles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add patterns and content style JSON generators, create formatters barrel</name>
  <files>
    src/export/formatters/json-layers.ts
    src/export/formatters/index.ts
    src/export/index.ts
  </files>
  <action>
1. Add to `src/export/formatters/json-layers.ts`:

**4. `generatePatternsJSON(patterns: StoredPattern[]): DualLayerExport<...>`**
- **Quick layer**: `Record<string, { type: string, confidence: number, pageCount: number }>` — pattern ID to summary.
- **Rich layer**: `Record<string, RichPattern>` where RichPattern = `{ type: string, pattern: any (the full DetectedFlow or content pattern data), evidence: { pageUrls: string[], selectors: string[], occurrenceCount: number, crossPageCount: number }, confidence: number, detectedAt: string }`. Directly maps from StoredPattern structure.
- Key by pattern ID.

**5. `generateContentStyleJSON(contentResult: ContentStyleResult): DualLayerExport<...>`**
- **Quick layer**: `{ voice: { tone: string, tense: string, perspective: string }, capitalization: Record<string, string> (context->style), ctaLevels: string[], errorStyle: { structure: string, tone: string } }` — fastest-path summary of content rules. Pick highest-confidence pattern for each.
- **Rich layer**: `{ voicePatterns: VoicePattern[], capitalizationPatterns: CapitalizationPattern[], ctaHierarchy: CTAHierarchy[], errorPatterns: ErrorMessagePattern[], totalSamples: number, confidence: number }` — full content style data with all patterns and examples.
- Content style is relatively small, so rich layer can include full examples arrays.

2. Create `src/export/formatters/index.ts` barrel:
   - Re-export all 5 generator functions from json-layers.ts
   - Export DualLayerExport type

3. Update `src/export/index.ts` barrel:
   - Add re-export from `./formatters/index.js`
  </action>
  <verify>
    - `npx tsc --noEmit --skipLibCheck` passes (0 errors)
    - All 5 generators exported from src/export/index.ts
  </verify>
  <done>
    - generatePatternsJSON exports flow patterns with quick and rich layers
    - generateContentStyleJSON exports content style rules with summarized quick layer and detailed rich layer
    - All 5 JSON generators accessible from src/export/index.ts
    - TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --skipLibCheck` — Zero TypeScript errors
- All 5 JSON generators exist and export correctly
- Quick layers have simple key-value structures
- Rich layers include evidence arrays and confidence objects
- Evidence index strips computedStyles for export size
</verification>

<success_criteria>
- tokens.json quick layer: token name -> CSS value string
- tokens.json rich layer: token name -> { value, type, description, evidence[], confidence }
- components.json: component type -> summary (quick) and full catalog (rich)
- patterns.json: pattern ID -> summary (quick) and full data (rich)
- content_style.json: highest-confidence rules (quick) and all patterns (rich)
- evidence_index.json: full evidence entries without computedStyles
</success_criteria>

<output>
After completion, create `.planning/phases/05-export-reporting/05-02-SUMMARY.md`
</output>
