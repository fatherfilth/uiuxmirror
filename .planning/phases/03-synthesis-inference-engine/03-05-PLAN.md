---
phase: 03-synthesis-inference-engine
plan: 05
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04"]
files_modified:
  - src/synthesis/evidence-tracker.ts
  - src/synthesis/component-composer.ts
  - src/synthesis/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Component composer orchestrates the full two-stage synthesis pipeline (rules -> LLM refinement)"
    - "Every synthesized element has a complete evidence chain tracing to source observations"
    - "Overall confidence score correctly weights token (1.0), structural (0.8), and LLM (0.6) decisions"
    - "synthesizeComponent() returns a complete SynthesizedComponent with HTML, CSS, states, accessibility, and evidence"
    - "Synthesis works in rules-only mode when Claude API is unavailable"
  artifacts:
    - path: "src/synthesis/evidence-tracker.ts"
      provides: "Evidence chain building and confidence calculation"
      exports: ["buildEvidenceChain", "calculateOverallConfidence", "mergeEvidenceChains"]
    - path: "src/synthesis/component-composer.ts"
      provides: "Top-level synthesis orchestrator combining all modules"
      exports: ["synthesizeComponent"]
    - path: "src/synthesis/index.ts"
      provides: "Complete synthesis module barrel export"
  key_links:
    - from: "src/synthesis/component-composer.ts"
      to: "src/synthesis/rule-engine.ts"
      via: "Stage 1: structural synthesis"
      pattern: "synthesizeStructure"
    - from: "src/synthesis/component-composer.ts"
      to: "src/synthesis/llm-refiner.ts"
      via: "Stage 2: LLM refinement"
      pattern: "llmRefine"
    - from: "src/synthesis/component-composer.ts"
      to: "src/synthesis/state-generator.ts"
      via: "generates interactive states"
      pattern: "generateAllStates"
    - from: "src/synthesis/component-composer.ts"
      to: "src/synthesis/a11y-generator.ts"
      via: "generates accessibility baseline"
      pattern: "generateA11yBaseline"
    - from: "src/synthesis/component-composer.ts"
      to: "src/synthesis/evidence-tracker.ts"
      via: "builds complete evidence chain"
      pattern: "buildEvidenceChain|calculateOverallConfidence"
    - from: "src/index.ts"
      to: "src/synthesis/index.ts"
      via: "re-exports synthesis module"
      pattern: "export.*from.*synthesis"
---

<objective>
Implement the evidence tracker for provenance and the component composer that orchestrates the full two-stage synthesis pipeline.

Purpose: The evidence tracker ensures every synthesized decision traces back to source observations (core project value). The component composer is the top-level orchestrator that combines rule engine, LLM refiner, state generator, and accessibility generator into a single `synthesizeComponent()` API. This is the primary entry point for Phase 3.

Output: Evidence tracker, component composer, and complete synthesis module wired into main index.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-synthesis-inference-engine/03-RESEARCH.md
@.planning/phases/03-synthesis-inference-engine/03-01-SUMMARY.md
@.planning/phases/03-synthesis-inference-engine/03-02-SUMMARY.md
@.planning/phases/03-synthesis-inference-engine/03-03-SUMMARY.md
@.planning/phases/03-synthesis-inference-engine/03-04-SUMMARY.md
@src/types/synthesis.ts
@src/synthesis/rule-engine.ts
@src/synthesis/llm-refiner.ts
@src/synthesis/state-generator.ts
@src/synthesis/a11y-generator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement evidence tracker and confidence calculator</name>
  <files>
    src/synthesis/evidence-tracker.ts
  </files>
  <action>
Create `src/synthesis/evidence-tracker.ts`:

**Core function: `buildEvidenceChain(decisions: SynthesisDecision[]): EvidenceLink[]`**
- Flatten all evidence links from all decisions
- Deduplicate by reference (same sourceType + reference = one entry)
- Sort by sourceType priority: observed_token > observed_component > inferred_pattern > llm_decision

**Core function: `calculateOverallConfidence(decisions: SynthesisDecision[]): { value: number; level: 'low' | 'medium' | 'high' }`**
- Weight decisions by type:
  - `token_application`: weight 1.0 (highest — directly observed)
  - `structural_choice`: weight 0.8 (rule-based, reliable)
  - `llm_refinement`: weight 0.6 (probabilistic, less certain)
- Formula: weightedSum = sum(decision.confidence * weight) / sum(weights)
- Clamp to [0, 1]
- Confidence levels: < 0.3 = 'low', < 0.6 = 'medium', >= 0.6 = 'high'
  (Consistent with Phase 2 confidence levels)

**Core function: `mergeEvidenceChains(...chains: EvidenceLink[][]): EvidenceLink[]`**
- Merge multiple evidence chains from different synthesis stages
- Deduplicate by reference
- Maintain sort order

**Helper: `createTokenDecision(property: string, value: string, tokenRef: string, pageUrls: string[]): SynthesisDecision`**
- Convenience factory for creating token_application decisions
- Automatically sets confidence: 0.95 (high, directly observed)
- Creates EvidenceLink with sourceType: 'observed_token'

**Helper: `createStructuralDecision(property: string, value: string, reasoning: string): SynthesisDecision`**
- Factory for structural_choice decisions
- Sets confidence: 0.85 (rule-based)
- Creates EvidenceLink with sourceType: 'inferred_pattern'

**Helper: `createLLMDecision(property: string, value: string, reasoning: string, llmConfidence: number): SynthesisDecision`**
- Factory for llm_refinement decisions
- Uses the LLM's own confidence rating
- Creates EvidenceLink with sourceType: 'llm_decision' and llmReasoning
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
  </verify>
  <done>
    Evidence tracker builds complete evidence chains and calculates weighted confidence scores. Factory helpers create decisions with appropriate confidence levels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement component composer (top-level orchestrator)</name>
  <files>
    src/synthesis/component-composer.ts
    src/synthesis/index.ts
    src/index.ts
  </files>
  <action>
Create `src/synthesis/component-composer.ts`:

**Primary API: `synthesizeComponent(request: ComponentRequest, designDNA: DesignDNA): Promise<SynthesizedComponent>`**

This is the main entry point for Phase 3. Orchestrates the full two-stage pipeline:

**Stage 1: Rule-based structural synthesis**
1. Call `synthesizeStructure(request, designDNA)` from rule-engine
2. This produces: HTML, CSS, tokenMap, structural decisions, evidence, confidence

**Stage 2: State generation**
3. Call `generateAllStates(structure.tokenMap, designDNA)` from state-generator
4. Produces 7 ComponentState objects (default through error)

**Stage 3: Accessibility baseline**
5. Call `generateA11yBaseline(request.type, structure.tokenMap)` from a11y-generator
6. Produces keyboard/focus/ARIA guidance

**Stage 4: LLM refinement (optional)**
7. Call `llmRefine(structure, designDNA)` from llm-refiner
8. If ANTHROPIC_API_KEY not set, this returns null refinements gracefully
9. If refinements available:
   - Merge motion timings into CSS (add transition properties)
   - Update loading/error states with LLM's presentation decisions
   - Add microcopy to HTML (button text, labels, etc.)
   - Add LLM decisions to the decision list

**Stage 5: Evidence assembly**
10. Merge all decisions from stages 1-4
11. Call `buildEvidenceChain()` to assemble complete evidence chain
12. Call `calculateOverallConfidence()` for final confidence score

**Stage 6: Assembly**
13. Build final `SynthesizedComponent`:
    - `type`: from request
    - `html`: from structure (possibly enhanced by LLM microcopy)
    - `css`: from structure (possibly enhanced by LLM motion timings)
    - `states`: from state generator (possibly enhanced by LLM edge states)
    - `accessibility`: from a11y generator
    - `decisions`: all decisions from all stages
    - `confidence`: overall confidence value
    - `confidenceLevel`: overall confidence level
    - `evidence`: complete evidence chain

**Helper: `mergeMotionIntoCSS(css: string, motionTimings: MotionTimingResult): string`**
- Insert transition CSS properties into the base CSS
- e.g., `transition: background-color 200ms ease, transform 150ms ease-out;`

**Helper: `mergeEdgeStatesIntoStates(states: ComponentState[], edgeStates: EdgeStateResult): ComponentState[]`**
- Replace skeleton loading/error states with LLM-refined versions
- Preserve deterministic states (hover, focus, disabled) unchanged

Update `src/synthesis/index.ts`:
- Export everything from all synthesis modules:
  - constraint-checker: validateTokenConstraints, resolveTokenValue, buildTokenMap
  - rule-engine: synthesizeStructure
  - template-registry: compileTemplate, getAvailableTemplates, registerHelpers
  - llm-refiner: llmRefine
  - prompt-builder: buildSystemPrompt
  - state-generator: generateAllStates
  - a11y-generator: generateA11yBaseline
  - evidence-tracker: buildEvidenceChain, calculateOverallConfidence
  - component-composer: synthesizeComponent

Update `src/index.ts`:
- Add `export * from './synthesis/index.js';` to wire synthesis module into main package export
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
    Verify `synthesizeComponent` is accessible from top-level: `src/index.ts` re-exports it.
  </verify>
  <done>
    Component composer orchestrates full two-stage synthesis pipeline. synthesizeComponent() is the primary Phase 3 API. Synthesis module fully wired into main package exports.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `synthesizeComponent` exported from `src/index.ts`
3. Evidence tracker produces deduplicated, sorted evidence chains
4. Overall confidence correctly weights token/structural/LLM decisions
5. Component composer handles both API-available and API-unavailable cases
6. All synthesis sub-modules accessible via `src/synthesis/index.ts`
</verification>

<success_criteria>
- synthesizeComponent() produces complete SynthesizedComponent
- Evidence chain traces every decision to source observation
- Confidence score accurately reflects synthesis quality
- Works in rules-only mode when Claude API unavailable
- Full synthesis module wired into main package
</success_criteria>

<output>
After completion, create `.planning/phases/03-synthesis-inference-engine/03-05-SUMMARY.md`
</output>
