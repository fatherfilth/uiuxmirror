---
phase: 03-synthesis-inference-engine
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/synthesis/state-generator.ts
  - src/synthesis/a11y-generator.ts
autonomous: true

must_haves:
  truths:
    - "State generator produces all 7 states (default, hover, active, focus, disabled, loading, error) for any component"
    - "Focus state meets WCAG 2.1 Level AA requirements (2px outline with 3:1 contrast)"
    - "Accessibility baseline includes keyboard navigation, focus management, and ARIA attributes per W3C APG"
    - "Deterministic states (hover, active, focus, disabled) use observed patterns from DesignDNA when available"
    - "A11y generator covers at least button, input, card, nav, modal, and data-table component types"
  artifacts:
    - path: "src/synthesis/state-generator.ts"
      provides: "Complete interactive state generation for synthesized components"
      exports: ["generateAllStates", "generateHoverState", "generateFocusState", "generateDisabledState"]
    - path: "src/synthesis/a11y-generator.ts"
      provides: "W3C ARIA APG-based accessibility baseline generation"
      exports: ["generateA11yBaseline"]
  key_links:
    - from: "src/synthesis/state-generator.ts"
      to: "src/types/synthesis.ts"
      via: "uses ComponentState type"
      pattern: "import.*ComponentState.*from.*synthesis"
    - from: "src/synthesis/a11y-generator.ts"
      to: "src/types/synthesis.ts"
      via: "uses A11yBaseline, KeyboardGuidance, AriaGuidance types"
      pattern: "import.*A11yBaseline.*from.*synthesis"
---

<objective>
Implement state generation for all 7 interactive states and accessibility baseline generation following W3C ARIA Authoring Practices Guide.

Purpose: Synthesized components must include complete state coverage (INFER-04) and accessibility baselines (INFER-05). These modules ensure generated components are interactive-ready and accessible by default. Deterministic states (hover, focus, disabled) use observed patterns; edge states (loading, error) provide skeleton structure for LLM refinement.

Output: State generator and accessibility generator modules.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-synthesis-inference-engine/03-RESEARCH.md
@.planning/phases/03-synthesis-inference-engine/03-01-SUMMARY.md
@src/types/synthesis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement state generator for all 7 interactive states</name>
  <files>
    src/synthesis/state-generator.ts
  </files>
  <action>
Create `src/synthesis/state-generator.ts`:

**Core function: `generateAllStates(tokenMap: Record<string, string>, designDNA: DesignDNA): ComponentState[]`**

Returns array of 7 ComponentState objects. Each state has: name, styles (diff from default), ariaAttributes, evidence, confidence.

**State implementations:**

1. **`generateDefaultState(tokenMap)`** — confidence: 1.0
   - Styles: the base tokenMap styles (backgroundColor, color, padding, fontSize, etc.)
   - Evidence: observed_token references for each token used

2. **`generateHoverState(tokenMap, designDNA)`** — confidence: 0.7-0.9
   - Check designDNA.components for observed hover patterns (from Phase 2 state-mapper)
   - If observed hover patterns exist: use the most common hover pattern, confidence: 0.9
   - If no observed patterns: apply deterministic rules:
     - Background: darken/lighten by 10% (use `adjustColorBrightness(hex, factor)` helper)
     - Optional: subtle translateY(-1px) if shadows observed in DNA
   - Evidence: observed_component or inferred_pattern depending on source
   - Styles returned as DIFF from default (only changed properties)

3. **`generateActiveState(tokenMap, designDNA)`** — confidence: 0.7-0.85
   - If observed active patterns exist: use them
   - Fallback: darken/lighten by 15%, scale(0.98), remove shadow
   - Evidence: observed or inferred

4. **`generateFocusState(tokenMap, designDNA)`** — confidence: 0.95
   - WCAG 2.1 Level AA focus indicator: `outline: 2px solid {focusColor}; outline-offset: 2px;`
   - focusColor: use primary color from DNA if contrast ratio >= 3:1 against background, else use '#005FCC' as safe default
   - ariaAttributes: none needed (focus is CSS-driven)
   - Evidence: inferred_pattern 'wcag-2.1-focus-visible'
   - High confidence because based on W3C standard

5. **`generateDisabledState(tokenMap)`** — confidence: 0.9
   - Styles: `opacity: '0.5'`, `cursor: 'not-allowed'`, `pointerEvents: 'none'`
   - ariaAttributes: `{ 'aria-disabled': 'true' }`
   - Evidence: inferred_pattern 'standard-disabled-opacity'
   - High confidence because standard pattern

6. **`generateLoadingState(tokenMap)`** — confidence: 0.5
   - Provide skeleton structure (LLM refiner will enhance):
     - Styles: `cursor: 'wait'`, `opacity: '0.7'`
     - ariaAttributes: `{ 'aria-busy': 'true', 'aria-live': 'polite' }`
   - Lower confidence because presentation details need LLM refinement
   - Evidence: inferred_pattern 'standard-loading-skeleton'

7. **`generateErrorState(tokenMap, designDNA)`** — confidence: 0.5-0.7
   - Check if error color exists in DNA tokens
   - Styles: `borderColor: errorColor || '#DC2626'`, `color: errorColor || '#DC2626'`
   - ariaAttributes: `{ 'aria-invalid': 'true', 'aria-live': 'assertive' }`
   - Evidence: observed_token if error color found, else inferred_pattern

**Helper: `adjustColorBrightness(hex: string, factor: number): string`**
- Parse hex to RGB, multiply each channel by factor, clamp to 0-255, return hex
- factor < 1.0 = darken, factor > 1.0 = lighten
- e.g., adjustColorBrightness('#3b82f6', 0.85) darkens by 15%

**Helper: `calculateContrastRatio(hex1: string, hex2: string): number`**
- Calculate WCAG contrast ratio between two colors
- Used to validate focus indicator meets 3:1 minimum
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
  </verify>
  <done>
    State generator produces all 7 interactive states. Deterministic states use observed patterns when available. Focus state meets WCAG 2.1 AA. Loading/error provide skeleton for LLM refinement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement accessibility baseline generator</name>
  <files>
    src/synthesis/a11y-generator.ts
    src/synthesis/index.ts
  </files>
  <action>
Create `src/synthesis/a11y-generator.ts`:

**W3C ARIA APG pattern database (inline constant, not external file):**

Define `ARIA_APG_PATTERNS` as a `Record<string, AriaPattern>` covering at least these component types:
- **button**: role='button', Enter/Space to activate, optional aria-pressed/aria-expanded
- **input**: role='textbox' (implicit for input), no special keys, aria-label/aria-describedby
- **card**: role='article' or 'region', not typically focusable unless interactive, aria-labelledby
- **nav**: role='navigation', Tab to navigate items, aria-label for nav region
- **modal**: role='dialog', Escape to close, Tab focus trap, aria-modal='true', aria-labelledby
- **data-table**: role='table' (implicit), Arrow keys for cell navigation, aria-label, column/row headers

Each pattern includes:
- `role: string`
- `tabIndex: number` (0 for focusable, -1 for programmatic focus)
- `keys: Array<{ key: string; action: string }>`
- `required: Record<string, string>` (required ARIA attributes with descriptions)
- `optional: Record<string, string>` (optional ARIA attributes)
- `focusManagement: { indicator: string; order: string; trap: boolean }`

**Core function: `generateA11yBaseline(componentType: string, tokenMap: Record<string, string>): A11yBaseline`**

1. Look up componentType in ARIA_APG_PATTERNS (case-insensitive, support aliases like 'table' -> 'data-table')
2. If pattern found:
   - Build KeyboardGuidance from pattern.keys
   - Build FocusGuidance with WCAG-compliant focus ring CSS using tokens (prefer primary color if 3:1 contrast met)
   - Build AriaGuidance from pattern.role and attributes
   - confidence: 0.95 (W3C standard)
   - wcagLevel: 'AA' (default target)
3. If pattern NOT found (unknown component type):
   - Return generic baseline: role='region', Tab focusable, basic aria-label guidance
   - confidence: 0.6 (generic, may not be optimal)
   - wcagLevel: 'A' (minimal compliance)
4. Return A11yBaseline

**Helper: `generateWCAGFocusRing(tokenMap: Record<string, string>): string`**
- Build CSS outline using primary color from tokens
- Format: `outline: 2px solid {color}; outline-offset: 2px;`
- Validate 3:1 contrast ratio against background; fallback to '#005FCC' if insufficient

**Helper: `getComponentTypeAliases(): Record<string, string>`**
- Map common aliases to canonical types: table->data-table, dialog->modal, textbox->input, navbar->nav, etc.

Update `src/synthesis/index.ts` to export state-generator and a11y-generator functions.
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
    Verify all 6 component types have ARIA patterns defined.
  </verify>
  <done>
    Accessibility baseline generator produces W3C APG-compliant keyboard/focus/ARIA guidance for 6+ component types. Unknown types get generic baseline with reduced confidence.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. State generator produces exactly 7 states per component
3. Focus state has WCAG 2.1 AA compliant outline (2px, 3:1 contrast)
4. Disabled state includes aria-disabled='true'
5. Loading state includes aria-busy='true'
6. A11y generator covers button, input, card, nav, modal, data-table
7. Unknown component types get generic baseline (not crash)
</verification>

<success_criteria>
- All 7 interactive states generated with appropriate confidence scores
- Accessibility baseline meets WCAG 2.1 Level AA
- W3C ARIA APG patterns correctly applied
- Graceful fallback for unknown component types
</success_criteria>

<output>
After completion, create `.planning/phases/03-synthesis-inference-engine/03-04-SUMMARY.md`
</output>
