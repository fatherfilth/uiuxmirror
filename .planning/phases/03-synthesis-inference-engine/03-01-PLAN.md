---
phase: 03-synthesis-inference-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/synthesis.ts
  - src/types/index.ts
  - src/synthesis/constraint-checker.ts
  - src/synthesis/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "Synthesis type definitions exist for all synthesis concepts (SynthesizedComponent, EvidenceLink, DesignDNA, ComponentRequest)"
    - "Constraint checker validates that token references exist in extracted design DNA"
    - "Constraint checker rejects synthesis requests when required tokens are missing"
    - "@anthropic-ai/sdk and handlebars are installed as dependencies"
  artifacts:
    - path: "src/types/synthesis.ts"
      provides: "All synthesis-related type definitions"
      contains: "SynthesizedComponent"
    - path: "src/synthesis/constraint-checker.ts"
      provides: "Token constraint validation against extracted DNA"
      exports: ["validateTokenConstraints", "resolveTokenValue"]
    - path: "src/synthesis/index.ts"
      provides: "Synthesis module barrel export"
  key_links:
    - from: "src/types/synthesis.ts"
      to: "src/types/normalized-tokens.ts"
      via: "imports NormalizationResult, ColorCluster, CrossPageResult"
      pattern: "import.*from.*normalized-tokens"
    - from: "src/types/synthesis.ts"
      to: "src/types/components.ts"
      via: "imports ComponentType, AggregatedComponent"
      pattern: "import.*from.*components"
    - from: "src/synthesis/constraint-checker.ts"
      to: "src/types/synthesis.ts"
      via: "uses DesignDNA and TokenConstraintResult types"
      pattern: "import.*from.*synthesis"
---

<objective>
Define all synthesis type definitions and implement the constraint checker that prevents token hallucination.

Purpose: Establishes the type foundation for the entire synthesis pipeline and the critical guard that ensures all synthesized components use only tokens observed in the source site. The constraint checker is the first line of defense against unanchored design guesses (core project value).

Output: TypeScript types for synthesis domain, installed SDK dependencies, and working constraint checker module.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-synthesis-inference-engine/03-RESEARCH.md
@src/types/normalized-tokens.ts
@src/types/components.ts
@src/types/tokens.ts
@src/normalization/normalize-pipeline.ts
@src/components/component-aggregator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and define synthesis types</name>
  <files>
    package.json
    src/types/synthesis.ts
    src/types/index.ts
  </files>
  <action>
1. Install dependencies:
   ```bash
   npm install @anthropic-ai/sdk handlebars
   npm install --save-dev @types/handlebars
   ```

2. Create `src/types/synthesis.ts` with the following types:

**DesignDNA** — The complete extracted design DNA from Phases 1-2, wrapping NormalizationResult + AggregatedComponent[]:
```typescript
interface DesignDNA {
  tokens: NormalizationResult;
  components: AggregatedComponent[];
  metadata: {
    sourceUrl: string;
    crawlDate: string;
    totalPages: number;
  };
}
```

**ComponentRequest** — What the user asks to synthesize:
```typescript
interface ComponentRequest {
  type: string;                    // e.g., "data-table", "search-bar", "pagination"
  description?: string;            // Optional user description
  constraints?: Record<string, string>; // Optional token overrides
}
```

**EvidenceLink** — Links a synthesis decision to source evidence:
```typescript
interface EvidenceLink {
  sourceType: 'observed_token' | 'observed_component' | 'inferred_pattern' | 'llm_decision';
  reference: string;               // Token ID, component type, or pattern name
  pageUrl?: string;
  selector?: string;
  occurrenceCount?: number;
  llmReasoning?: string;
}
```

**SynthesisDecision** — A single decision in the synthesis process:
```typescript
interface SynthesisDecision {
  type: 'token_application' | 'structural_choice' | 'llm_refinement';
  property: string;                // CSS property or structural element
  value: string;                   // Chosen value
  confidence: number;              // 0-1
  evidence: EvidenceLink[];
  reasoning: string;
}
```

**ComponentState** — A single interactive state:
```typescript
interface ComponentState {
  name: 'default' | 'hover' | 'active' | 'focus' | 'disabled' | 'loading' | 'error';
  styles: Record<string, string>;
  ariaAttributes?: Record<string, string>;
  evidence: EvidenceLink[];
  confidence: number;
}
```

**A11yBaseline** — Accessibility guidance for a component:
```typescript
interface KeyboardGuidance {
  keys: Array<{ key: string; action: string }>;
  tabIndex: number;
  example: string;
}

interface FocusGuidance {
  focusIndicator: string;
  focusOrder: string;
  focusTrap?: boolean;
}

interface AriaGuidance {
  role: string;
  requiredAttributes: Record<string, string>;
  optionalAttributes: Record<string, string>;
  liveRegion?: 'polite' | 'assertive';
}

interface A11yBaseline {
  keyboardNavigation: KeyboardGuidance;
  focusManagement: FocusGuidance;
  ariaPattern: AriaGuidance;
  confidence: number;
  wcagLevel: 'A' | 'AA' | 'AAA';
}
```

**SynthesizedComponent** — The final output:
```typescript
interface SynthesizedComponent {
  type: string;
  html: string;
  css: string;
  states: ComponentState[];
  accessibility: A11yBaseline;
  decisions: SynthesisDecision[];
  confidence: number;              // Overall confidence (0-1)
  confidenceLevel: 'low' | 'medium' | 'high';
  evidence: EvidenceLink[];
}
```

**TokenConstraintResult** — Result of token validation:
```typescript
interface TokenConstraintResult {
  valid: boolean;
  resolved: Record<string, string>; // property -> resolved token value
  missing: string[];                // properties with no matching token
  confidence: number;               // 0-1 based on coverage
}
```

3. Update `src/types/index.ts` to add synthesis type re-exports.
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
    Run `npm ls @anthropic-ai/sdk handlebars` — both packages installed.
  </verify>
  <done>
    All synthesis types defined and exported. @anthropic-ai/sdk and handlebars installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement constraint checker</name>
  <files>
    src/synthesis/constraint-checker.ts
    src/synthesis/index.ts
  </files>
  <action>
Create `src/synthesis/constraint-checker.ts` that validates token references against extracted DesignDNA.

**Core function: `validateTokenConstraints()`**
- Takes a record of CSS property names -> token category hints (e.g., `{ backgroundColor: 'color', padding: 'spacing', fontSize: 'typography' }`) and the DesignDNA
- For each property:
  - Look up the token category in DesignDNA.tokens (colors.standards, typography.standards, spacing.standards, radii.standards, shadows.standards, motion.standards)
  - If a matching standard token exists, resolve to its value
  - If no match, add to `missing` list
- Return `TokenConstraintResult` with resolved values, missing list, and confidence (resolved / total)

**Helper function: `resolveTokenValue()`**
- Given a token category ('color', 'spacing', 'typography', 'radius', 'shadow', 'motion') and an optional index/name hint
- Looks up the token in DesignDNA.tokens.{category}.standards
- Returns the token value and an EvidenceLink with sourceType: 'observed_token'
- For colors: returns canonical hex value from ColorCluster
- For typography: returns font properties from NormalizedTypographyToken
- For spacing: returns pixel value from NormalizedSpacingToken
- For radii/shadows/motion: returns appropriate value

**Helper function: `buildTokenMap()`**
- Creates a flat lookup map from DesignDNA for quick token resolution
- Maps semantic names to values: `{ 'color-primary': '#3b82f6', 'spacing-md': '16px', ... }`
- Uses the DTCG output naming conventions (color-1, spacing-xs, heading-1, etc.)

Create `src/synthesis/index.ts` barrel export with all synthesis module exports.

Important: The constraint checker must NEVER fabricate token values. If a token is not found in DesignDNA, it goes in the `missing` list. This is the core anti-hallucination guard.
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
    Verify exports: `node -e "import('./dist/synthesis/index.js').then(m => console.log(Object.keys(m)))"` or just check TypeScript compilation.
  </verify>
  <done>
    Constraint checker validates token references against extracted DNA. Missing tokens are reported, never fabricated. Barrel export wires synthesis module.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. `npm ls @anthropic-ai/sdk handlebars` shows both installed
3. `src/types/synthesis.ts` contains SynthesizedComponent, DesignDNA, EvidenceLink, ComponentState, A11yBaseline types
4. `src/synthesis/constraint-checker.ts` exports validateTokenConstraints and resolveTokenValue
5. `src/synthesis/index.ts` barrel export exists
</verification>

<success_criteria>
- All synthesis types compile without errors
- Constraint checker can validate token references against DesignDNA
- Missing tokens are identified (never fabricated)
- Dependencies installed
</success_criteria>

<output>
After completion, create `.planning/phases/03-synthesis-inference-engine/03-01-SUMMARY.md`
</output>
