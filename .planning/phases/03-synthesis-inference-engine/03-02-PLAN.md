---
phase: 03-synthesis-inference-engine
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/synthesis/rule-engine.ts
  - src/synthesis/templates/button.hbs
  - src/synthesis/templates/card.hbs
  - src/synthesis/templates/input.hbs
  - src/synthesis/templates/data-table.hbs
  - src/synthesis/templates/modal.hbs
  - src/synthesis/templates/nav.hbs
  - src/synthesis/template-registry.ts
autonomous: true

must_haves:
  truths:
    - "Rule engine generates HTML+CSS structure from Handlebars templates using extracted tokens"
    - "All token values in generated output trace back to DesignDNA (no hardcoded colors/sizes)"
    - "Templates exist for at least 6 component types (button, card, input, data-table, modal, nav)"
    - "Rule engine returns evidence chain linking each structural decision to source"
  artifacts:
    - path: "src/synthesis/rule-engine.ts"
      provides: "Deterministic structural synthesis using templates and design tokens"
      exports: ["synthesizeStructure"]
    - path: "src/synthesis/template-registry.ts"
      provides: "Template loading and Handlebars compilation with custom helpers"
      exports: ["compileTemplate", "registerHelpers"]
    - path: "src/synthesis/templates/button.hbs"
      provides: "Button component template"
    - path: "src/synthesis/templates/data-table.hbs"
      provides: "Data table component template"
  key_links:
    - from: "src/synthesis/rule-engine.ts"
      to: "src/synthesis/constraint-checker.ts"
      via: "validates tokens before template compilation"
      pattern: "validateTokenConstraints"
    - from: "src/synthesis/rule-engine.ts"
      to: "src/synthesis/template-registry.ts"
      via: "compiles Handlebars templates"
      pattern: "compileTemplate"
    - from: "src/synthesis/template-registry.ts"
      to: "handlebars"
      via: "template engine"
      pattern: "import.*handlebars"
---

<objective>
Implement the rule-based structural synthesis engine that generates HTML+CSS from Handlebars templates using only extracted design tokens.

Purpose: This is Stage 1 of the two-stage synthesis pipeline. The rule engine handles deterministic decisions (structure, token application) leaving nuanced decisions (motion, edge states, microcopy) for the LLM refiner. This separation ensures reproducibility and auditability.

Output: Rule engine module, template registry, and 6+ Handlebars component templates.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-synthesis-inference-engine/03-RESEARCH.md
@.planning/phases/03-synthesis-inference-engine/03-01-SUMMARY.md
@src/types/synthesis.ts
@src/synthesis/constraint-checker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template registry and Handlebars templates</name>
  <files>
    src/synthesis/template-registry.ts
    src/synthesis/templates/button.hbs
    src/synthesis/templates/card.hbs
    src/synthesis/templates/input.hbs
    src/synthesis/templates/data-table.hbs
    src/synthesis/templates/modal.hbs
    src/synthesis/templates/nav.hbs
  </files>
  <action>
Create `src/synthesis/template-registry.ts`:
- **`registerHelpers()`**: Register custom Handlebars helpers:
  - `{{ifEqual a b}}` - conditional equality check
  - `{{fallback primary secondary}}` - use primary if exists, else secondary
  - `{{cssValue property value}}` - wrap CSS property-value pair
- **`compileTemplate(templateName: string)`**: Reads .hbs file from templates/ directory, compiles with Handlebars, returns compiled function. Cache compiled templates in a Map for reuse.
- **`getAvailableTemplates()`**: Returns list of available template names.
- Templates are loaded from `src/synthesis/templates/` directory using fs-extra readFileSync (templates are small, sync is fine).

Create 6 Handlebars templates, each using `{{tokens.*}}` placeholders. Templates must NEVER include hardcoded design values (colors, sizes, fonts). All visual properties come from token placeholders.

**button.hbs**: Button with size variants (small/medium/large), emphasis variants (primary/secondary/ghost). Token placeholders: `tokens.color.primary`, `tokens.color.onPrimary`, `tokens.color.border`, `tokens.spacing.sm/md/lg`, `tokens.radius.md`, `tokens.typography.body.fontSize`, `tokens.typography.body.fontFamily`.

**card.hbs**: Card container with header, body, optional footer. Token placeholders: `tokens.color.background`, `tokens.color.border`, `tokens.color.text`, `tokens.spacing.md/lg`, `tokens.radius.md`, `tokens.shadow.sm`.

**input.hbs**: Text input with label, placeholder, optional error message. Token placeholders: `tokens.color.text`, `tokens.color.border`, `tokens.color.background`, `tokens.color.error`, `tokens.spacing.sm/md`, `tokens.radius.sm`, `tokens.typography.body.fontSize`.

**data-table.hbs**: Table with header row, body rows, hover state. Token placeholders: `tokens.color.text`, `tokens.color.textSecondary`, `tokens.color.border`, `tokens.color.backgroundHover`, `tokens.spacing.md`, `tokens.typography.heading.fontWeight`, `tokens.typography.body.fontSize`.

**modal.hbs**: Dialog with backdrop, header, body, actions. Token placeholders: `tokens.color.background`, `tokens.color.backdrop`, `tokens.color.text`, `tokens.spacing.lg/xl`, `tokens.radius.lg`, `tokens.shadow.lg`.

**nav.hbs**: Navigation bar with links, active state. Token placeholders: `tokens.color.background`, `tokens.color.text`, `tokens.color.primary`, `tokens.spacing.md/lg`, `tokens.typography.body.fontSize`.

Each template outputs both HTML structure and an embedded `<style>` block with CSS. Use BEM-style class names (e.g., `.synth-button`, `.synth-button--primary`, `.synth-card__header`).
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
    Verify all 6 .hbs files exist in src/synthesis/templates/.
  </verify>
  <done>
    Template registry compiles Handlebars templates with caching. 6 component templates created with token placeholders (no hardcoded values).
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement rule-based synthesis engine</name>
  <files>
    src/synthesis/rule-engine.ts
    src/synthesis/index.ts
  </files>
  <action>
Create `src/synthesis/rule-engine.ts`:

**Core function: `synthesizeStructure(request: ComponentRequest, designDNA: DesignDNA): StructuralSynthesis`**

`StructuralSynthesis` interface (add to synthesis.ts types if not already there):
```typescript
interface StructuralSynthesis {
  html: string;
  css: string;
  templateName: string;
  tokenMap: Record<string, string>;  // All resolved token values used
  decisions: SynthesisDecision[];
  evidence: EvidenceLink[];
  confidence: number;
}
```

Implementation steps:
1. **Select template**: Match `request.type` to available template. If exact match not found, check aliases (e.g., "table" -> "data-table", "dialog" -> "modal", "navbar" -> "nav", "text-input" -> "input"). If no match at all, throw descriptive error listing available templates.

2. **Build token context**: Use `buildTokenMap()` from constraint-checker to create flat token lookup. Map template token placeholders to resolved values from DesignDNA.

3. **Resolve tokens**: For each template token placeholder, resolve from DesignDNA:
   - `tokens.color.*` → from `designDNA.tokens.colors.standards` (canonical hex from ColorCluster)
   - `tokens.spacing.*` → from `designDNA.tokens.spacing.standards` (pixel values, map xs/sm/md/lg by ascending sort)
   - `tokens.typography.*` → from `designDNA.tokens.typography.standards`
   - `tokens.radius.*` → from `designDNA.tokens.radii.standards`
   - `tokens.shadow.*` → from `designDNA.tokens.shadows.standards`
   - `tokens.color.primary` → first color standard (highest frequency)
   - `tokens.color.onPrimary` → contrast color for primary (use simple luminance check: light bg -> dark text, dark bg -> light text)

4. **Validate constraints**: Call `validateTokenConstraints()` to verify all resolved tokens exist in DNA. If critical tokens missing (>50% unresolved), throw error. If some missing, use fallback values and log warnings, reducing confidence.

5. **Compile template**: Use `compileTemplate()` from registry, pass resolved token context.

6. **Extract HTML and CSS**: Split compiled output at `<style>` tag boundary.

7. **Build evidence chain**: For each resolved token, create an EvidenceLink with `sourceType: 'observed_token'`, the token reference ID, and page URLs from the CrossPageResult evidence.

8. **Calculate confidence**: Based on token resolution coverage (resolved / total template tokens).

9. **Return StructuralSynthesis** with all data.

**Helper: `resolveColorContrast(backgroundColor: string): string`**
- Simple luminance-based contrast: parse hex, calculate relative luminance, return '#000000' or '#ffffff'.
- Used for `tokens.color.onPrimary` and similar text-on-background tokens.

Update `src/synthesis/index.ts` to export rule-engine and template-registry functions.
  </action>
  <verify>
    Run `npx tsc --noEmit` — must pass with 0 errors.
    Verify `synthesizeStructure` is exported from synthesis/index.ts.
  </verify>
  <done>
    Rule engine synthesizes HTML+CSS from templates using only extracted design tokens. Evidence chain links every token usage to source observations. Confidence reflects token coverage.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with 0 errors
2. 6 Handlebars templates exist in src/synthesis/templates/
3. Template registry caches compiled templates
4. Rule engine resolves tokens from DesignDNA (never fabricates values)
5. Evidence chain created for each token application
6. Confidence score reflects token resolution coverage
</verification>

<success_criteria>
- Rule engine can generate HTML+CSS structure for all 6 template types
- All token values in output trace to DesignDNA
- Missing tokens are reported with reduced confidence, never invented
- Evidence chain is complete for all structural decisions
</success_criteria>

<output>
After completion, create `.planning/phases/03-synthesis-inference-engine/03-02-SUMMARY.md`
</output>
