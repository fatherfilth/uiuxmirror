---
phase: 03-synthesis-inference-engine
plan: 06
type: tdd
wave: 4
depends_on: ["03-05"]
files_modified:
  - tests/synthesis/constraint-checker.test.ts
  - tests/synthesis/rule-engine.test.ts
  - tests/synthesis/state-generator.test.ts
  - tests/synthesis/a11y-generator.test.ts
  - tests/synthesis/evidence-tracker.test.ts
  - tests/integration/phase3-synthesis.test.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests validate constraint checker rejects missing tokens and resolves existing ones"
    - "Unit tests validate rule engine generates HTML+CSS with only DesignDNA tokens"
    - "Unit tests validate all 7 states are generated with correct ARIA attributes"
    - "Unit tests validate accessibility baselines for all 6 component types"
    - "Integration test validates full synthesis pipeline from request to SynthesizedComponent"
    - "All tests pass without requiring ANTHROPIC_API_KEY (LLM tests use graceful degradation)"
  artifacts:
    - path: "tests/synthesis/constraint-checker.test.ts"
      provides: "Constraint checker unit tests"
    - path: "tests/synthesis/rule-engine.test.ts"
      provides: "Rule engine unit tests"
    - path: "tests/synthesis/state-generator.test.ts"
      provides: "State generator unit tests"
    - path: "tests/synthesis/a11y-generator.test.ts"
      provides: "Accessibility generator unit tests"
    - path: "tests/synthesis/evidence-tracker.test.ts"
      provides: "Evidence tracker unit tests"
    - path: "tests/integration/phase3-synthesis.test.ts"
      provides: "End-to-end synthesis pipeline integration test"
  key_links:
    - from: "tests/integration/phase3-synthesis.test.ts"
      to: "src/synthesis/component-composer.ts"
      via: "tests synthesizeComponent end-to-end"
      pattern: "synthesizeComponent"
    - from: "tests/synthesis/rule-engine.test.ts"
      to: "src/synthesis/rule-engine.ts"
      via: "tests structural synthesis"
      pattern: "synthesizeStructure"
---

<objective>
Write comprehensive unit and integration tests for the Phase 3 synthesis pipeline.

Purpose: Validates that synthesis works correctly end-to-end without requiring Claude API access. Tests ensure constraint checking prevents hallucination, rule engine uses only extracted tokens, states are complete, and accessibility meets W3C standards. Integration test validates the full pipeline from ComponentRequest to SynthesizedComponent.

Output: Test suite covering all synthesis modules with mock DesignDNA fixtures.
</objective>

<execution_context>
@C:/Users/Karl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Karl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-synthesis-inference-engine/03-RESEARCH.md
@.planning/phases/03-synthesis-inference-engine/03-05-SUMMARY.md
@src/types/synthesis.ts
@src/synthesis/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write unit tests for synthesis modules</name>
  <files>
    tests/synthesis/constraint-checker.test.ts
    tests/synthesis/rule-engine.test.ts
    tests/synthesis/state-generator.test.ts
    tests/synthesis/a11y-generator.test.ts
    tests/synthesis/evidence-tracker.test.ts
  </files>
  <action>
First, create a shared test fixture: a mock DesignDNA object that mimics real Phase 2 output. This fixture should include:
- 3-5 color standards (with ColorCluster canonical values, evidence, pageUrls)
- 3-4 typography standards (heading, body, small)
- 4-5 spacing standards (xs through xl)
- 2 radius standards
- 1-2 shadow standards
- 1-2 motion standards
- 2 aggregated components (button, card) with canonical styles
- metadata: sourceUrl, crawlDate, totalPages

Place this fixture at the top of each test file or in a shared helper (e.g., `tests/synthesis/fixtures.ts`).

**tests/synthesis/constraint-checker.test.ts** (8-10 tests):
- `validateTokenConstraints()` resolves existing color tokens correctly
- `validateTokenConstraints()` resolves existing spacing tokens correctly
- `validateTokenConstraints()` reports missing tokens in missing[] list
- `validateTokenConstraints()` calculates confidence based on resolution coverage
- `validateTokenConstraints()` returns valid:true when all tokens found
- `validateTokenConstraints()` returns valid:false when >50% tokens missing
- `resolveTokenValue()` returns correct hex for color tokens
- `resolveTokenValue()` returns correct pixel value for spacing tokens
- `buildTokenMap()` creates flat lookup from DesignDNA

**tests/synthesis/rule-engine.test.ts** (6-8 tests):
- `synthesizeStructure()` generates HTML containing token values (not hardcoded)
- `synthesizeStructure()` generates CSS with resolved token values
- `synthesizeStructure()` creates evidence chain for each token used
- `synthesizeStructure()` selects correct template for component type
- `synthesizeStructure()` resolves template aliases (e.g., 'table' -> 'data-table')
- `synthesizeStructure()` throws descriptive error for unknown template
- `synthesizeStructure()` calculates confidence based on token coverage
- Generated HTML does not contain any unresolved `{{` placeholders

**tests/synthesis/state-generator.test.ts** (8-10 tests):
- `generateAllStates()` returns exactly 7 states
- States include: default, hover, active, focus, disabled, loading, error
- Focus state has WCAG-compliant outline (contains 'outline' in styles)
- Disabled state includes aria-disabled='true'
- Loading state includes aria-busy='true' and aria-live='polite'
- Error state includes aria-invalid='true'
- Hover state styles differ from default state
- Each state has confidence score > 0
- Each state has at least one evidence link

**tests/synthesis/a11y-generator.test.ts** (8-10 tests):
- `generateA11yBaseline('button')` returns role='button' with Enter/Space keys
- `generateA11yBaseline('modal')` returns role='dialog' with Escape key and focus trap
- `generateA11yBaseline('input')` returns appropriate role with ARIA attributes
- `generateA11yBaseline('data-table')` returns role='table' with arrow key navigation
- `generateA11yBaseline('nav')` returns role='navigation'
- Unknown component type returns generic baseline (not crash)
- All baselines have wcagLevel of 'A' or 'AA'
- Focus indicator CSS is non-empty for all types
- Confidence is >= 0.9 for known types, lower for unknown

**tests/synthesis/evidence-tracker.test.ts** (6-8 tests):
- `buildEvidenceChain()` deduplicates evidence links by reference
- `buildEvidenceChain()` sorts by sourceType priority
- `calculateOverallConfidence()` weights token_application highest (1.0)
- `calculateOverallConfidence()` weights llm_refinement lowest (0.6)
- `calculateOverallConfidence()` returns correct confidence levels
- `mergeEvidenceChains()` combines multiple chains without duplicates
- Factory helpers create decisions with correct types and confidence
  </action>
  <verify>
    Run `npx vitest run tests/synthesis/` — all tests must pass.
    Run `npx tsc --noEmit` — must pass with 0 errors.
  </verify>
  <done>
    Unit tests cover constraint checker, rule engine, state generator, a11y generator, and evidence tracker. All pass without API key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write integration test for full synthesis pipeline</name>
  <files>
    tests/integration/phase3-synthesis.test.ts
  </files>
  <action>
Create `tests/integration/phase3-synthesis.test.ts`:

This test validates the full synthesis pipeline end-to-end using the mock DesignDNA fixture (same as unit tests or imported from shared fixtures).

**Test: "synthesizeComponent produces complete button component"**
1. Create ComponentRequest: `{ type: 'button' }`
2. Call `synthesizeComponent(request, mockDesignDNA)` (without ANTHROPIC_API_KEY set)
3. Verify result has:
   - `type === 'button'`
   - `html` is non-empty and contains no unresolved `{{` placeholders
   - `css` is non-empty
   - `states` has exactly 7 entries covering all state names
   - `accessibility` has `role === 'button'` and keyboard keys include 'Enter'
   - `decisions` array is non-empty
   - `confidence` is between 0 and 1
   - `confidenceLevel` is 'low', 'medium', or 'high'
   - `evidence` array is non-empty

**Test: "synthesizeComponent produces complete data-table component"**
1. Create ComponentRequest: `{ type: 'data-table' }`
2. Call `synthesizeComponent(request, mockDesignDNA)`
3. Verify: html non-empty, states complete, a11y has role='table'

**Test: "synthesizeComponent handles unknown type gracefully"**
1. Create ComponentRequest: `{ type: 'carousel' }` (no template)
2. Call `synthesizeComponent(request, mockDesignDNA)`
3. Expect error thrown with descriptive message listing available templates

**Test: "synthesizeComponent supports template aliases"**
1. Create ComponentRequest: `{ type: 'dialog' }` (alias for modal)
2. Call `synthesizeComponent(request, mockDesignDNA)`
3. Verify: completes successfully, html non-empty

**Test: "synthesized component evidence traces to source DNA"**
1. Synthesize a button component
2. For each evidence link with sourceType 'observed_token':
   - Verify the reference matches a token that exists in mockDesignDNA
3. Verify no evidence links have empty reference strings

**Test: "synthesized component HTML uses only DNA token values"**
1. Synthesize a button component
2. Extract all CSS color values from the generated CSS (regex for #[0-9a-fA-F]{6})
3. Verify each color exists in the mockDesignDNA color standards
4. (This is the anti-hallucination validation test)

**Test: "synthesis works in rules-only mode (no API key)"**
1. Ensure ANTHROPIC_API_KEY is not set (or set to empty)
2. Synthesize a card component
3. Verify: result is complete, all required fields present
4. Verify: loading/error states have lower confidence (skeleton versions)

Ensure ALL tests pass without ANTHROPIC_API_KEY set. The test suite must be fully runnable in CI without API credentials.
  </action>
  <verify>
    Run `npx vitest run tests/integration/phase3-synthesis.test.ts` — all tests must pass.
    Run `npx vitest run` — ALL project tests must pass (Phase 1 + Phase 2 + Phase 3).
    Run `npx tsc --noEmit` — must pass with 0 errors.
  </verify>
  <done>
    Integration tests validate full synthesis pipeline end-to-end. Anti-hallucination test confirms all colors trace to DNA. All tests pass without API key. Total test suite (all phases) passes.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — ALL tests pass (Phase 1 + Phase 2 + Phase 3)
2. `npx tsc --noEmit` passes with 0 errors
3. No test requires ANTHROPIC_API_KEY
4. Integration test validates complete SynthesizedComponent structure
5. Anti-hallucination test verifies all token values trace to DNA
6. Evidence completeness validated (no empty references)
</verification>

<success_criteria>
- All unit tests pass for synthesis modules
- Integration test validates full pipeline end-to-end
- Anti-hallucination test catches any unanchored design values
- Total project test suite passes (all phases)
- No API key required for test execution
</success_criteria>

<output>
After completion, create `.planning/phases/03-synthesis-inference-engine/03-06-SUMMARY.md`
</output>
